<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IREME Attendance Tracker Pro</title>
    <meta name="description" content="Professional Student Attendance Tracking System for IREME & Move Up Global">
    <meta name="theme-color" content="#4CAF50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS styles from the original code remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #F44336;
            --warning: #FF9800;
            --success: #4CAF50;
            --dark: #212121;
            --light: #f5f5f5;
            --border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            animation: fadeInUp 0.5s;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header i {
            font-size: 4em;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .login-header h1 {
            color: var(--dark);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            width: 100%;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #45a049);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #1976D2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #d32f2f);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f57c00);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #45a049);
            color: white;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            width: auto;
        }

        .app-container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none;
        }

        .app-container.show {
            display: block;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary), #45a049);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 1.6em;
            margin-bottom: 5px;
        }

        .header-title p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
        }

        .user-info span {
            font-size: 0.9em;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:active {
            transform: scale(0.95);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            min-width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: white;
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .nav-tab.hidden {
            display: none;
        }

        .content {
            padding: 20px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: var(--light);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), #45a049);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card.secondary {
            background: linear-gradient(135deg, var(--secondary), #1976D2);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger), #d32f2f);
        }

        .stat-number {
            font-size: 2.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.95em;
            opacity: 0.95;
        }

        .student-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s;
        }

        .student-item:active {
            background: var(--light);
        }

        .student-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .student-info {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .student-name {
            font-weight: 600;
            color: var(--dark);
        }

        .student-id {
            color: var(--secondary);
            font-family: monospace;
            font-weight: 600;
        }

        .student-gender {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .gender-male {
            background: #e3f2fd;
            color: #1976d2;
        }

        .gender-female {
            background: #fce4ec;
            color: #c2185b;
        }

        /* Mobile-optimized QR Scanner */
        .scanner-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        #qr-reader {
            border-radius: 10px;
            overflow: hidden;
            max-width: 100%;
            margin: 0 auto;
            position: relative;
        }

        #qr-reader video {
            width: 100% !important;
            height: auto !important;
            border-radius: 10px;
            max-height: 60vh;
            object-fit: cover;
        }

        #qr-reader__scan_region {
            border-radius: 10px !important;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid var(--primary);
            border-radius: 15px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.3);
        }

        .scanner-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: var(--primary);
            top: 10%;
            animation: scanLine 2s infinite;
        }

        @keyframes scanLine {
            0%, 100% { top: 10%; }
            50% { top: 90%; }
        }

        .scanner-controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 100;
        }

        .scanner-controls .btn {
            margin: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: 2px solid white;
            width: auto;
            display: inline-block;
        }

        .manual-entry {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .manual-entry input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1.2em;
            text-align: center;
            font-family: monospace;
            text-transform: uppercase;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 15px 45px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 1.2em;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success);
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger);
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning);
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid var(--secondary);
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .records-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .records-table tr:active {
            background: var(--light);
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 3px dashed var(--border);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--light);
        }

        .file-upload:active {
            border-color: var(--primary);
            background: rgba(76, 175, 80, 0.05);
        }

        .file-upload i {
            font-size: 3em;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: zoomIn 0.3s;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 1.5em;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }

        .close-btn:active {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #45a049);
            width: 0%;
            transition: width 0.3s;
        }

        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .offline-indicator.show {
            display: block;
        }

        .date-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .qr-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            page-break-inside: avoid;
        }

        .qr-code-display {
            margin: 10px auto;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 10px;
            background: white;
            display: inline-block;
        }

        .qr-code-display canvas {
            display: block;
            margin: 0 auto;
        }

        .qr-card-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .qr-card-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .qr-card-id {
            font-family: monospace;
            color: var(--secondary);
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1em;
        }

        .qr-card-detail {
            color: #666;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .qr-card-school {
            color: var(--primary);
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.95em;
        }

        .user-management-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details {
            flex: 1;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        /* Password strength indicator */
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .password-strength.weak {
            background: var(--danger);
            width: 33%;
        }

        .password-strength.medium {
            background: var(--warning);
            width: 66%;
        }

        .password-strength.strong {
            background: var(--success);
            width: 100%;
        }

        /* Sync status */
        .sync-status {
            display: none;
            margin-top: 15px;
        }

        .fa-spin {
            animation: fa-spin 2s infinite linear;
        }

        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Fixed URL display */
        .fixed-url-display {
            background: #f8f9fa;
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: monospace;
            word-break: break-all;
            border-left: 4px solid var(--primary);
        }

        @media (max-width: 768px) {
            .app-container {
                margin: 10px;
                border-radius: 15px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .student-info {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: auto;
            }

            .quick-actions {
                flex-direction: column;
            }

            .quick-actions .btn {
                width: 100%;
            }

            .qr-grid {
                grid-template-columns: 1fr;
            }

            .user-management-card {
                flex-direction: column;
                gap: 10px;
            }

            .user-actions {
                width: 100%;
                justify-content: center;
            }

            .scanner-controls .btn {
                padding: 10px 15px;
                font-size: 0.8em;
            }

            .fixed-url-display {
                font-size: 0.8em;
                padding: 10px;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .modal, .modal * {
                visibility: visible;
            }
            .modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white;
            }
            .modal-content {
                box-shadow: none;
                border: none;
            }
            .close-btn, .quick-actions {
                display: none !important;
            }
            .qr-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            .qr-card {
                break-inside: avoid;
                border: 2px solid #000;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <i class="fas fa-clipboard-check"></i>
                <h1>IREME Attendance Tracker</h1>
                <p>Move Up Global & IREME Education for Social Impact</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="loginUsername" required placeholder="Enter your username">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-user-tag"></i> Login As</label>
                    <select id="loginRole" required>
                        <option value="">Select Role</option>
                        <option value="representative">Class Representative</option>
                        <option value="internal">Internal Team</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>

            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px; font-size: 0.9em;">
                <strong>Default Admin:</strong><br>
                Username: admin<br>
                Password: Avasgnyawe@123
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="header-content">
                <div class="header-title">
                    <h1><i class="fas fa-clipboard-check"></i> IREME Attendance Pro</h1>
                    <p>Move Up Global & IREME Education for Social Impact</p>
                </div>
                <div class="user-info">
                    <span><i class="fas fa-user"></i> <strong id="currentUser">User</strong></span>
                    <span><i class="fas fa-user-tag"></i> <strong id="currentRole">Role</strong></span>
                    <span><i class="fas fa-calendar"></i> <strong id="currentDate"></strong></span>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="take-attendance" id="tabTakeAttendance">
                <i class="fas fa-check-circle"></i> Take Attendance
            </button>
            <button class="nav-tab" data-tab="view-records" id="tabViewRecords">
                <i class="fas fa-history"></i> View Records
            </button>
            <button class="nav-tab hidden" data-tab="admin" id="tabAdmin">
                <i class="fas fa-user-shield"></i> Admin Panel
            </button>
            <button class="nav-tab hidden" data-tab="settings" id="tabSettings">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Take Attendance Tab -->
            <div id="take-attendance" class="tab-content active">
                <div class="date-display">
                    <i class="fas fa-calendar-day"></i> Today: <span id="attendanceDate"></span>
                </div>

                <!-- Selection Form -->
                <div class="form-section">
                    <h3><i class="fas fa-school"></i> Select Class</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>School *</label>
                            <select id="selectSchool" required>
                                <option value="">Select School</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Class *</label>
                            <select id="selectClass" required>
                                <option value="">Select Class</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Academic Year *</label>
                            <select id="selectAcademicYear" required>
                                <option value="">Select Year</option>
                                <option value="2024-2025" selected>2024-2025</option>
                                <option value="2025-2026">2025-2026</option>
                                <option value="2026-2027">2026-2027</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Term *</label>
                            <select id="selectTerm" required>
                                <option value="">Select Term</option>
                                <option value="Term1">Term 1</option>
                                <option value="Term2">Term 2</option>
                                <option value="Term3">Term 3</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="startAttendanceBtn">
                        <i class="fas fa-play"></i> Start Taking Attendance
                    </button>
                </div>

                <!-- Attendance Interface -->
                <div id="attendanceInterface" style="display: none;">
                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card secondary">
                            <div class="stat-number" id="presentCount">0</div>
                            <div class="stat-label">Present</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-number" id="absentCount">0</div>
                            <div class="stat-label">Absent</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button class="btn btn-primary btn-small" id="markAllPresentBtn">
                            <i class="fas fa-check-double"></i> Mark All Present
                        </button>
                        <button class="btn btn-danger btn-small" id="markAllAbsentBtn">
                            <i class="fas fa-times"></i> Mark All Absent
                        </button>
                        <button class="btn btn-secondary btn-small" id="toggleScannerBtn">
                            <i class="fas fa-qrcode"></i> QR Scanner
                        </button>
                        <button class="btn btn-warning btn-small" id="toggleManualEntryBtn">
                            <i class="fas fa-keyboard"></i> Manual Entry
                        </button>
                    </div>

                    <!-- QR Scanner -->
                    <div id="scannerSection" class="scanner-container" style="display: none;">
                        <h3><i class="fas fa-qrcode"></i> Scan Student QR Code</h3>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <div>Point your camera at the student's QR code. The system will automatically mark them present.</div>
                        </div>
                        <div id="qr-reader">
                            <div class="scanner-overlay">
                                <div class="scanner-frame">
                                    <div class="scanner-line"></div>
                                </div>
                            </div>
                        </div>
                        <div class="scanner-controls" id="scannerControls" style="display: none;"></div>
                        <button class="btn btn-danger" id="stopScannerBtn" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-stop"></i> Stop Scanner
                        </button>
                    </div>

                    <!-- Manual Entry -->
                    <div id="manualEntrySection" class="manual-entry" style="display: none;">
                        <h3><i class="fas fa-keyboard"></i> Enter Student ID Manually</h3>
                        <input type="text" id="manualStudentId" placeholder="Enter Student ID (e.g., XXXXXX01)">
                        <button class="btn btn-primary" id="markManualBtn" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-check"></i> Mark Present
                        </button>
                    </div>

                    <!-- Search -->
                    <div class="search-box">
                        <input type="text" id="studentSearch" placeholder="Search student by name or ID...">
                        <i class="fas fa-search"></i>
                    </div>

                    <!-- Student List -->
                    <div class="student-list" id="studentList"></div>

                    <!-- Submit Button -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" id="submitAttendanceBtn" style="padding: 15px 40px; font-size: 1.1em;">
                            <i class="fas fa-paper-plane"></i> Submit Attendance
                        </button>
                    </div>
                </div>
            </div>

            <!-- View Records Tab -->
            <div id="view-records" class="tab-content">
                <div class="form-section">
                    <h3><i class="fas fa-filter"></i> Filter Records</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>School</label>
                            <select id="filterSchool">
                                <option value="">All Schools</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Class</label>
                            <select id="filterClass">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date From</label>
                            <input type="date" id="filterDateFrom">
                        </div>
                        <div class="form-group">
                            <label>Date To</label>
                            <input type="date" id="filterDateTo">
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" id="exportRecordsBtn">
                            <i class="fas fa-download"></i> Export Records
                        </button>
                        <button class="btn btn-secondary" id="syncSheetsBtn">
                            <i class="fas fa-sync"></i> Sync with Google Sheets
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>School</th>
                                <th>Class</th>
                                <th>Total</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Rate</th>
                                <th>Representative</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="admin" class="tab-content">
                <!-- User Management -->
                <div class="form-section">
                    <h3><i class="fas fa-users-cog"></i> User Management</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Admin Privileges:</strong> Create, edit, and delete user accounts. Assign roles and manage permissions.
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" id="newUserUsername" placeholder="Enter username" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="password" id="newUserPassword" placeholder="Enter password (min 6 characters)" autocomplete="new-password">
                            <div class="password-strength" id="passwordStrength"></div>
                        </div>
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="newUserFullName" placeholder="Full name" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Role *</label>
                            <select id="newUserRole">
                                <option value="">Select Role</option>
                                <option value="representative">Class Representative</option>
                                <option value="internal">Internal Team</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" id="addUserBtn">
                        <i class="fas fa-user-plus"></i> Add User
                    </button>
                </div>

                <!-- Current Users -->
                <div class="form-section">
                    <h3><i class="fas fa-users"></i> Current Users</h3>
                    <div id="usersList"></div>
                </div>

                <!-- Bulk Student Upload -->
                <div class="form-section">
                    <h3><i class="fas fa-upload"></i> Bulk Student Upload</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Excel Format Required:</strong> Student ID, Name, Gender, School, Class<br>
                            <small>The system will automatically generate QR codes for all students</small>
                        </div>
                    </div>
                    <div class="file-upload" id="bulkUploadArea">
                        <i class="fas fa-file-excel"></i>
                        <h4>Click to Upload Excel File</h4>
                        <p>Supported: .xlsx, .xls, .csv</p>
                        <input type="file" id="bulkStudentFile" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText" style="text-align: center; margin-top: 10px;"></p>
                    </div>
                </div>

                <!-- Add Single Student -->
                <div class="form-section">
                    <h3><i class="fas fa-user-plus"></i> Add Individual Student</h3>
                    <form id="addStudentForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Student ID *</label>
                                <input type="text" id="newStudentId" required placeholder="e.g., ABC123">
                            </div>
                            <div class="form-group">
                                <label>Student Name *</label>
                                <input type="text" id="newStudentName" required placeholder="Full Name">
                            </div>
                            <div class="form-group">
                                <label>Gender *</label>
                                <select id="newStudentGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>School *</label>
                                <select id="newStudentSchool" required>
                                    <option value="">Select School</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Class *</label>
                                <select id="newStudentClass" required>
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                        </div>
                        <div class="quick-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                            <button type="button" class="btn btn-secondary" id="generateSingleQRBtn">
                                <i class="fas fa-qrcode"></i> Generate QR Code
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Manage Students -->
                <div class="form-section">
                    <h3><i class="fas fa-search"></i> Search & Manage Students</h3>
                    <div class="search-box">
                        <input type="text" id="adminSearch" placeholder="Search by name or ID...">
                        <i class="fas fa-search"></i>
                    </div>
                    <div id="adminStudentList"></div>
                </div>

                <!-- Manage Schools -->
                <div class="form-section">
                    <h3><i class="fas fa-school"></i> Manage Schools & Classes</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Add New School</label>
                            <input type="text" id="newSchoolName" placeholder="School Name">
                            <button class="btn btn-primary btn-small" id="addSchoolBtn" style="margin-top: 10px; width: 100%;">
                                <i class="fas fa-plus"></i> Add School
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Add Class to School</label>
                            <select id="schoolForClass">
                                <option value="">Select School</option>
                            </select>
                            <input type="text" id="newClassName" placeholder="e.g., P1 A" style="margin-top: 10px;">
                            <button class="btn btn-primary btn-small" id="addClassBtn" style="margin-top: 10px; width: 100%;">
                                <i class="fas fa-plus"></i> Add Class
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <!-- Enhanced Google Sheets Integration -->
                <div class="form-section">
                    <h3><i class="fas fa-link"></i> Google Sheets Integration</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Dual Sheet Configuration:</strong><br>
                            Primary URL is fixed for centralized data collection.<br>
                            Secondary URL is optional for additional backup storage.
                        </div>
                    </div>
                    
                    <!-- Fixed Primary URL -->
                    <div class="form-group">
                        <label>Primary Google Apps Script URL (Fixed) *</label>
                        <div class="fixed-url-display">
                            <strong>https://script.google.com/macros/s/AKfycbx9Gmmmfhu6uOTtCy0lEE367eXa3niMxO3Cp81i6eKKUkZLV4Gb4AVCj6Cr3D82arwkOA/exec</strong>
                        </div>
                        <small>This URL is fixed and cannot be changed. All data will be sent to this centralized storage.</small>
                    </div>
                    
                    <!-- Editable Secondary URL -->
                    <div class="form-group">
                        <label>Secondary/Backup URL (Optional)</label>
                        <input type="url" id="secondarySheetsUrl" placeholder="https://script.google.com/...">
                        <small>Additional backup URL for your own storage (optional)</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Sync Frequency</label>
                        <select id="syncFrequency">
                            <option value="realtime">Real-time (immediate)</option>
                            <option value="5min" selected>Every 5 minutes</option>
                            <option value="15min">Every 15 minutes</option>
                            <option value="manual">Manual only</option>
                        </select>
                    </div>

                    <div class="quick-actions">
                        <button class="btn btn-primary" id="saveSheetsSettingsBtn">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        <button class="btn btn-secondary" id="testAllConnectionsBtn">
                            <i class="fas fa-plug"></i> Test All Connections
                        </button>
                        <button class="btn btn-success" id="manualSyncBtn">
                            <i class="fas fa-sync"></i> Sync Now
                        </button>
                    </div>

                    <div id="syncStatus" class="sync-status">
                        <div class="alert alert-info">
                            <i class="fas fa-sync-alt fa-spin"></i>
                            <div id="syncStatusText">Syncing data...</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-database"></i> Data Management</h3>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Warning:</strong> These actions will affect all stored data. Use with caution.
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-secondary" id="exportAllDataBtn">
                            <i class="fas fa-download"></i> Export All Data (Backup)
                        </button>
                        <button class="btn btn-warning" id="importDataBtn">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                        <button class="btn btn-danger" id="clearAllDataBtn">
                            <i class="fas fa-trash-alt"></i> Clear All Data
                        </button>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-mobile-alt"></i> Mobile App Installation</h3>
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Install on Mobile:</strong><br>
                            <strong>iOS:</strong> Tap Share  Add to Home Screen<br>
                            <strong>Android:</strong> Tap Menu ()  Add to Home Screen<br>
                            The app will work offline and use your device camera for QR scanning.
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> App Information</h3>
                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h4>IREME Attendance Tracker Professional v3.0</h4>
                        <p><strong>Developed for:</strong> IREME & Move Up Global</p>
                        <p><strong>Features:</strong></p>
                        <ul style="text-align: left; margin: 15px 0;">
                            <li> Full admin user management with password controls</li>
                            <li> Mobile-optimized QR scanning (iOS & Android)</li>
                            <li> Offline-capable attendance tracking</li>
                            <li> Cloud data storage integration</li>
                            <li> Bulk student upload via Excel</li>
                            <li> Automatic QR code generation</li>
                            <li> Google Sheets integration</li>
                            <li> Real-time statistics & editing</li>
                            <li> Multi-school & multi-class support</li>
                            <li> Role-based access control</li>
                            <li> Progressive Web App (installable)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-qrcode"></i> Student QR Codes</h2>
                <button class="close-btn" id="closeQRModal">&times;</button>
            </div>
            <div id="qrCodeDisplay"></div>
            <div class="quick-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" id="printQRCardsBtn">
                    <i class="fas fa-print"></i> Print QR Cards
                </button>
                <button class="btn btn-secondary" id="downloadQRCardsBtn">
                    <i class="fas fa-download"></i> Download as Image
                </button>
                <button class="btn btn-success" id="downloadAllQRCodesBtn">
                    <i class="fas fa-file-archive"></i> Download ZIP
                </button>
            </div>
        </div>
    </div>

    <!-- Record Detail Modal -->
    <div id="recordDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-clipboard-list"></i> Attendance Details</h2>
                <button class="close-btn" id="closeRecordDetailModal">&times;</button>
            </div>
            <div id="recordDetailContent"></div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h2>
                <button class="close-btn" id="closeEditUserModal">&times;</button>
            </div>
            <div id="editUserContent">
                <form id="editUserForm">
                    <input type="hidden" id="editUserOriginalUsername">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="editUserUsername" required>
                        </div>
                        <div class="form-group">
                            <label>New Password (leave blank to keep current)</label>
                            <input type="password" id="editUserPassword" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="editUserFullName" required>
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select id="editUserRole" required>
                                <option value="representative">Class Representative</option>
                                <option value="internal">Internal Team</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('editUserModal').classList.remove('show')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i> Offline Mode - Data will sync when online
    </div>

    <script>
        // Fixed Primary Google Apps Script URL - CANNOT BE CHANGED
        const PRIMARY_GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx9Gmmmfhu6uOTtCy0lEE367eXa3niMxO3Cp81i6eKKUkZLV4Gb4AVCj6Cr3D82arwkOA/exec";

        // Enhanced Global Variables
        let appData = {
            users: [
                { username: 'admin', password: 'Avasgnyawe@123', role: 'admin', fullName: 'System Administrator', created: new Date().toISOString(), createdBy: 'system' }
            ],
            schools: [],
            students: [],
            attendanceRecords: [],
            settings: {
                // primarySheetsUrl is now fixed and not stored in settings
                secondarySheetsUrl: '',
                syncFrequency: '5min',
                lastSync: null
            },
            systemLog: []
        };

        let currentUser = null;
        let currentAttendance = {
            school: '',
            schoolId: null,
            class: '',
            academicYear: '',
            term: '',
            date: '',
            representative: '',
            students: []
        };

        let html5QrCode = null;
        let isScanning = false;
        let currentCameraId = null;

        // Enhanced Storage Functions with Auto-sync
        function loadFromStorage() {
            const stored = localStorage.getItem('iremeAttendanceData');
            if (stored) {
                try {
                    const loaded = JSON.parse(stored);
                    appData = { ...appData, ...loaded };
                    logSystemActivity('SYSTEM_START', 'Data loaded from storage');
                } catch (error) {
                    console.error('Error loading data:', error);
                    initializeSampleData();
                }
            } else {
                initializeSampleData();
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('iremeAttendanceData', JSON.stringify(appData));
                // Auto-sync with cloud if online
                if (navigator.onLine) {
                    setTimeout(syncAllDataToCloud, 1000); // Delay to avoid blocking UI
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showAlert('Error saving data. Please check storage space.', 'error');
            }
        }

        function initializeSampleData() {
            appData.schools = [
                {
                    id: 1,
                    name: 'RWINZOVU PRIMARY SCHOOL',
                    classes: ['N1', 'N2', 'N3', 'P1 A', 'P1 B', 'P2 A', 'P2 B', 'P3', 'P4', 'P5', 'P6']
                },
                {
                    id: 2,
                    name: 'MUSANZE SECONDARY SCHOOL',
                    classes: ['S1 A', 'S1 B', 'S2 A', 'S2 B', 'S3', 'S4', 'S5', 'S6']
                }
            ];

            appData.students = [
                { id: 'RWN001', name: 'UWIMANA Jean', gender: 'Male', schoolId: 1, class: 'P6' },
                { id: 'RWN002', name: 'MUKAMANA Alice', gender: 'Female', schoolId: 1, class: 'P6' },
                { id: 'RWN003', name: 'HABIMANA Eric', gender: 'Male', schoolId: 1, class: 'P6' },
                { id: 'MUS001', name: 'NIYONSENGA Grace', gender: 'Female', schoolId: 2, class: 'S3' },
                { id: 'MUS002', name: 'UWASE David', gender: 'Male', schoolId: 2, class: 'S3' }
            ];

            saveToStorage();
        }

        // System logging for tracking all activities
        function logSystemActivity(action, details, user = currentUser) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                user: user ? user.username : 'system',
                userRole: user ? user.role : 'system',
                ip: 'local'
            };
            
            appData.systemLog.unshift(logEntry);
            
            // Keep only last 1000 log entries to prevent storage bloat
            if (appData.systemLog.length > 1000) {
                appData.systemLog = appData.systemLog.slice(0, 1000);
            }
            
            saveToStorage();
        }

        // Enhanced sync function for cloud storage - Uses fixed primary URL
        async function syncAllDataToCloud() {
            if (!navigator.onLine) {
                return false;
            }

            try {
                const syncData = {
                    action: 'syncAllData',
                    timestamp: new Date().toISOString(),
                    data: appData,
                    syncType: 'full'
                };

                // Always sync to primary URL (fixed)
                const response = await fetch(PRIMARY_GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(syncData)
                });

                if (response.ok) {
                    appData.settings.lastSync = new Date().toISOString();
                    saveToStorage();
                    logSystemActivity('CLOUD_SYNC', 'All data synced to primary cloud storage');
                    
                    // Also sync to secondary URL if configured
                    if (appData.settings.secondarySheetsUrl) {
                        try {
                            await fetch(appData.settings.secondarySheetsUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(syncData)
                            });
                            logSystemActivity('CLOUD_SYNC', 'Data also synced to secondary storage');
                        } catch (secondaryError) {
                            console.error('Secondary sync failed:', secondaryError);
                        }
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Primary cloud sync failed:', error);
                logSystemActivity('CLOUD_SYNC_ERROR', 'Failed to sync with primary cloud: ' + error.message);
            }
            return false;
        }

        // Initialize App
        function initApp() {
            loadFromStorage();
            updateCurrentDate();
            checkOnlineStatus();
            setupEventListeners();
            setupEnhancedEventListeners();
            
            setInterval(updateCurrentDate, 60000);
            setInterval(saveToStorage, 30000); // Auto-save every 30 seconds
            
            // Auto-sync interval based on settings
            setInterval(autoSyncData, getSyncInterval());
            
            window.addEventListener('online', () => {
                document.getElementById('offlineIndicator').classList.remove('show');
                showAlert('Back online! Syncing data...', 'success');
                autoSyncData();
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('offlineIndicator').classList.add('show');
                showAlert('You are offline. Working in local mode.', 'warning');
            });

            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    console.log('Service worker registration optional');
                });
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation Tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Attendance
            document.getElementById('selectSchool').addEventListener('change', loadClasses);
            document.getElementById('startAttendanceBtn').addEventListener('click', startAttendance);
            document.getElementById('markAllPresentBtn').addEventListener('click', markAllPresent);
            document.getElementById('markAllAbsentBtn').addEventListener('click', markAllAbsent);
            document.getElementById('toggleScannerBtn').addEventListener('click', toggleScanner);
            document.getElementById('toggleManualEntryBtn').addEventListener('click', toggleManualEntry);
            document.getElementById('stopScannerBtn').addEventListener('click', stopScanner);
            document.getElementById('markManualBtn').addEventListener('click', markByManualId);
            document.getElementById('manualStudentId').addEventListener('keypress', handleManualEntry);
            document.getElementById('studentSearch').addEventListener('input', searchStudents);
            document.getElementById('submitAttendanceBtn').addEventListener('click', submitAttendance);

            // Admin - Password strength indicator
            document.getElementById('newUserPassword').addEventListener('input', function() {
                checkPasswordStrength(this.value);
            });

            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('addStudentForm').addEventListener('submit', addStudent);
            document.getElementById('generateSingleQRBtn').addEventListener('click', generateQRCode);
            document.getElementById('adminSearch').addEventListener('input', searchAdminStudents);
            document.getElementById('addSchoolBtn').addEventListener('click', addSchool);
            document.getElementById('addClassBtn').addEventListener('click', addClass);
            document.getElementById('newStudentSchool').addEventListener('change', updateNewStudentClasses);

            // File Upload
            document.getElementById('bulkUploadArea').addEventListener('click', () => {
                document.getElementById('bulkStudentFile').click();
            });
            document.getElementById('bulkStudentFile').addEventListener('change', handleBulkUpload);

            // Settings - Now only for secondary URL
            document.getElementById('saveSheetsSettingsBtn').addEventListener('click', saveSheetsSettings);
            document.getElementById('testAllConnectionsBtn').addEventListener('click', testAllConnections);
            document.getElementById('manualSyncBtn').addEventListener('click', manualSync);
            document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
            document.getElementById('importDataBtn').addEventListener('click', importData);
            document.getElementById('clearAllDataBtn').addEventListener('click', clearAllData);

            // Records
            document.getElementById('exportRecordsBtn').addEventListener('click', exportRecords);
            document.getElementById('syncSheetsBtn').addEventListener('click', syncWithGoogleSheets);

            // Modals
            document.getElementById('closeQRModal').addEventListener('click', closeQRModal);
            document.getElementById('closeRecordDetailModal').addEventListener('click', closeRecordDetailModal);
            document.getElementById('closeEditUserModal').addEventListener('click', () => {
                document.getElementById('editUserModal').classList.remove('show');
            });
            document.getElementById('printQRCardsBtn').addEventListener('click', printQRCards);
            document.getElementById('downloadQRCardsBtn').addEventListener('click', downloadQRCardsAsPDF);
            document.getElementById('downloadAllQRCodesBtn').addEventListener('click', downloadAllQRCodes);
            document.getElementById('editUserForm').addEventListener('submit', saveUserEdit);

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            });
        }

        // Enhanced Event Listeners for New Features
        function setupEnhancedEventListeners() {
            // Online/offline detection for auto-sync
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
        }

        function handleOnlineStatus() {
            showAlert('Back online! Syncing data...', 'success');
            autoSyncData();
        }

        function handleOfflineStatus() {
            showAlert('You are offline. Working in local mode.', 'warning');
        }

        // Password Strength Checker
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('passwordStrength');
            if (!password) {
                strengthBar.className = 'password-strength';
                return;
            }

            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            if (strength <= 2) {
                strengthBar.className = 'password-strength weak';
            } else if (strength <= 3) {
                strengthBar.className = 'password-strength medium';
            } else {
                strengthBar.className = 'password-strength strong';
            }
        }

        // Authentication
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const role = document.getElementById('loginRole').value;
            
            const user = appData.users.find(u => 
                u.username === username && 
                u.password === password && 
                u.role === role
            );
            
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').classList.add('show');
                document.getElementById('currentUser').textContent = user.fullName;
                document.getElementById('currentRole').textContent = user.role.toUpperCase();
                
                setupUIForRole(user.role);
                populateSchoolSelects();
                populateFilterSelects();
                
                logSystemActivity('USER_LOGIN', 'User logged in successfully');
                showAlert(`Welcome ${user.fullName}!`, 'success');
            } else {
                showAlert('Invalid credentials or role. Please try again.', 'error');
            }
        }

        function setupUIForRole(role) {
            const adminElements = document.querySelectorAll('#tabAdmin, #tabSettings');
            
            if (role === 'admin') {
                adminElements.forEach(el => el.classList.remove('hidden'));
            } else {
                adminElements.forEach(el => el.classList.add('hidden'));
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                logSystemActivity('USER_LOGOUT', 'User logged out');
                currentUser = null;
                stopScanner();
                document.getElementById('mainApp').classList.remove('show');
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('loginForm').reset();
                switchTab('take-attendance');
            }
        }

        // Update Date
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = now.toLocaleDateString('en-US', options);
            document.getElementById('currentDate').textContent = dateStr;
            if (document.getElementById('attendanceDate')) {
                document.getElementById('attendanceDate').textContent = dateStr;
            }
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'view-records') {
                loadRecords();
            } else if (tabName === 'admin') {
                loadUsersList();
                loadAdminStudents();
                populateSchoolSelects();
            } else if (tabName === 'settings') {
                // Load current settings - Only secondary URL is editable
                document.getElementById('secondarySheetsUrl').value = appData.settings.secondarySheetsUrl || '';
                document.getElementById('syncFrequency').value = appData.settings.syncFrequency || '5min';
            }
        }

        // Populate School Selects
        function populateSchoolSelects() {
            const selects = ['selectSchool', 'newStudentSchool', 'schoolForClass', 'filterSchool'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select School</option>';
                    appData.schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        select.appendChild(option);
                    });
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        // Load Classes
        function loadClasses() {
            const schoolId = document.getElementById('selectSchool').value;
            const classSelect = document.getElementById('selectClass');
            
            classSelect.innerHTML = '<option value="">Select Class</option>';
            
            if (schoolId) {
                const school = appData.schools.find(s => s.id == schoolId);
                if (school && school.classes) {
                    school.classes.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });
                }
            }
        }

        // Start Attendance
        function startAttendance() {
            const schoolId = document.getElementById('selectSchool').value;
            const className = document.getElementById('selectClass').value;
            const academicYear = document.getElementById('selectAcademicYear').value;
            const term = document.getElementById('selectTerm').value;
            
            if (!schoolId || !className || !academicYear || !term) {
                showAlert('Please select all required fields', 'error');
                return;
            }
            
            const school = appData.schools.find(s => s.id == schoolId);
            
            currentAttendance = {
                school: school.name,
                schoolId: schoolId,
                class: className,
                academicYear: academicYear,
                term: term,
                date: new Date().toISOString().split('T')[0],
                representative: currentUser.fullName,
                students: []
            };
            
            // Load students for selected school and class
            const filteredStudents = appData.students.filter(student => 
                student.schoolId == schoolId && student.class === className
            );
            
            currentAttendance.students = filteredStudents.map(student => ({
                id: student.id,
                name: student.name,
                gender: student.gender,
                present: false
            }));
            
            document.getElementById('attendanceInterface').style.display = 'block';
            updateStats();
            displayStudentList();
            
            logSystemActivity('ATTENDANCE_STARTED', `Started attendance for ${school.name} - ${className}`);
            showAlert(`Attendance started for ${school.name} - ${className}`, 'success');
        }

        // Display Student List
        function displayStudentList() {
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '';
            
            currentAttendance.students.forEach((student, index) => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                studentItem.innerHTML = `
                    <input type="checkbox" class="student-checkbox" id="student-${index}" 
                           ${student.present ? 'checked' : ''} 
                           onchange="toggleAttendance(${index})">
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-id">${student.id}</div>
                        <div class="student-gender ${student.gender === 'Male' ? 'gender-male' : 'gender-female'}">
                            ${student.gender}
                        </div>
                    </div>
                `;
                studentList.appendChild(studentItem);
            });
        }

        // Toggle Attendance
        function toggleAttendance(index) {
            const checkbox = document.getElementById(`student-${index}`);
            currentAttendance.students[index].present = checkbox.checked;
            updateStats();
        }

        // Update Stats
        function updateStats() {
            const total = currentAttendance.students.length;
            const present = currentAttendance.students.filter(s => s.present).length;
            const absent = total - present;
            
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
        }

        // Mark All Present
        function markAllPresent() {
            currentAttendance.students.forEach(student => {
                student.present = true;
            });
            displayStudentList();
            updateStats();
            showAlert('All students marked as present', 'success');
        }

        // Mark All Absent
        function markAllAbsent() {
            currentAttendance.students.forEach(student => {
                student.present = false;
            });
            displayStudentList();
            updateStats();
            showAlert('All students marked as absent', 'success');
        }

        // Toggle Scanner
        function toggleScanner() {
            const scannerSection = document.getElementById('scannerSection');
            const manualEntrySection = document.getElementById('manualEntrySection');
            
            if (scannerSection.style.display === 'none') {
                scannerSection.style.display = 'block';
                manualEntrySection.style.display = 'none';
                startQRScanner();
            } else {
                scannerSection.style.display = 'none';
                stopScanner();
            }
        }

        // Toggle Manual Entry
        function toggleManualEntry() {
            const manualEntrySection = document.getElementById('manualEntrySection');
            const scannerSection = document.getElementById('scannerSection');
            
            if (manualEntrySection.style.display === 'none') {
                manualEntrySection.style.display = 'block';
                scannerSection.style.display = 'none';
                stopScanner();
            } else {
                manualEntrySection.style.display = 'none';
            }
        }

        // Start QR Scanner
        function startQRScanner() {
            if (isScanning) return;
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            Html5Qrcode.getCameras().then(cameras => {
                if (cameras && cameras.length) {
                    const cameraId = cameras[0].id;
                    currentCameraId = cameraId;
                    
                    html5QrCode.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        (decodedText) => {
                            // QR Code scanned successfully
                            handleQRScan(decodedText);
                        },
                        (errorMessage) => {
                            // QR Code scanning failed, ignore errors
                        }
                    ).then(() => {
                        isScanning = true;
                    }).catch(err => {
                        console.error("Unable to start QR scanner:", err);
                        showAlert('Unable to start camera. Please check permissions.', 'error');
                    });
                }
            }).catch(err => {
                console.error("Error getting cameras:", err);
                showAlert('Cannot access camera. Please check permissions.', 'error');
            });
        }

        // Handle QR Scan
        function handleQRScan(decodedText) {
            // Find student by ID
            const studentIndex = currentAttendance.students.findIndex(student => 
                student.id === decodedText
            );
            
            if (studentIndex !== -1) {
                // Mark student as present
                currentAttendance.students[studentIndex].present = true;
                
                // Update UI
                const checkbox = document.getElementById(`student-${studentIndex}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
                
                updateStats();
                
                // Show success message
                showAlert(`${currentAttendance.students[studentIndex].name} marked present via QR code`, 'success');
                
                // Play success sound if available
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
                    audio.play();
                } catch (e) {
                    // Ignore audio errors
                }
            } else {
                showAlert(`Student with ID ${decodedText} not found in this class`, 'error');
            }
        }

        // Stop Scanner
        function stopScanner() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    currentCameraId = null;
                }).catch(err => {
                    console.error("Error stopping QR scanner:", err);
                });
            }
        }

        // Mark by Manual ID
        function markByManualId() {
            const manualId = document.getElementById('manualStudentId').value.trim().toUpperCase();
            
            if (!manualId) {
                showAlert('Please enter a student ID', 'error');
                return;
            }
            
            // Find student by ID
            const studentIndex = currentAttendance.students.findIndex(student => 
                student.id === manualId
            );
            
            if (studentIndex !== -1) {
                // Mark student as present
                currentAttendance.students[studentIndex].present = true;
                
                // Update UI
                const checkbox = document.getElementById(`student-${studentIndex}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
                
                updateStats();
                
                // Clear input
                document.getElementById('manualStudentId').value = '';
                
                showAlert(`${currentAttendance.students[studentIndex].name} marked present`, 'success');
            } else {
                showAlert(`Student with ID ${manualId} not found in this class`, 'error');
            }
        }

        // Handle Manual Entry
        function handleManualEntry(event) {
            if (event.key === 'Enter') {
                markByManualId();
            }
        }

        // Search Students
        function searchStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const studentItems = document.querySelectorAll('.student-item');
            
            studentItems.forEach(item => {
                const name = item.querySelector('.student-name').textContent.toLowerCase();
                const id = item.querySelector('.student-id').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || id.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Submit Attendance
        function submitAttendance() {
            const presentCount = currentAttendance.students.filter(s => s.present).length;
            const absentCount = currentAttendance.students.length - presentCount;
            
            if (presentCount === 0 && absentCount === 0) {
                showAlert('No attendance data to submit', 'error');
                return;
            }
            
            // Create record
            const record = {
                id: Date.now().toString(),
                ...currentAttendance,
                timestamp: new Date().toISOString(),
                submittedBy: currentUser.username,
                presentCount: presentCount,
                absentCount: absentCount,
                attendanceRate: presentCount / currentAttendance.students.length * 100
            };
            
            // Add to records
            appData.attendanceRecords.unshift(record);
            
            // Save to storage
            saveToStorage();
            
            // Send to Google Sheets
            sendToGoogleSheets(record);
            
            // Reset attendance interface
            document.getElementById('attendanceInterface').style.display = 'none';
            document.getElementById('scannerSection').style.display = 'none';
            document.getElementById('manualEntrySection').style.display = 'none';
            stopScanner();
            
            // Show success message
            showAlert(`Attendance submitted successfully! ${presentCount} present, ${absentCount} absent`, 'success');
            
            // Log activity
            logSystemActivity('ATTENDANCE_SUBMITTED', `Submitted attendance for ${record.school} - ${record.class}`);
            
            // Switch to records tab
            switchTab('view-records');
        }

        // Load Records
        function loadRecords() {
            const tableBody = document.getElementById('recordsTableBody');
            tableBody.innerHTML = '';
            
            // Apply filters
            const schoolFilter = document.getElementById('filterSchool').value;
            const classFilter = document.getElementById('filterClass').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            const filteredRecords = appData.attendanceRecords.filter(record => {
                if (schoolFilter && record.schoolId != schoolFilter) return false;
                if (classFilter && record.class !== classFilter) return false;
                if (dateFrom && record.date < dateFrom) return false;
                if (dateTo && record.date > dateTo) return false;
                return true;
            });
            
            if (filteredRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No records found</td></tr>';
                return;
            }
            
            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>${record.school}</td>
                    <td>${record.class}</td>
                    <td>${record.students.length}</td>
                    <td>${record.presentCount}</td>
                    <td>${record.absentCount}</td>
                    <td>${record.attendanceRate.toFixed(1)}%</td>
                    <td>${record.representative}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="viewRecordDetails('${record.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // View Record Details
        function viewRecordDetails(recordId) {
            const record = appData.attendanceRecords.find(r => r.id === recordId);
            if (!record) return;
            
            const modal = document.getElementById('recordDetailModal');
            const content = document.getElementById('recordDetailContent');
            
            let html = `
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Attendance Details</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Date</label>
                            <p>${new Date(record.date).toLocaleDateString()}</p>
                        </div>
                        <div class="form-group">
                            <label>School</label>
                            <p>${record.school}</p>
                        </div>
                        <div class="form-group">
                            <label>Class</label>
                            <p>${record.class}</p>
                        </div>
                        <div class="form-group">
                            <label>Academic Year</label>
                            <p>${record.academicYear}</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-users"></i> Student Attendance</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${record.students.length}</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card secondary">
                            <div class="stat-number">${record.presentCount}</div>
                            <div class="stat-label">Present</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-number">${record.absentCount}</div>
                            <div class="stat-label">Absent</div>
                        </div>
                    </div>
                    
                    <div class="student-list">
            `;
            
            record.students.forEach(student => {
                html += `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-id">${student.id}</div>
                            <div class="student-gender ${student.gender === 'Male' ? 'gender-male' : 'gender-female'}">
                                ${student.gender}
                            </div>
                            <div style="color: ${student.present ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                                ${student.present ? 'PRESENT' : 'ABSENT'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            modal.classList.add('show');
        }

        // Close Record Detail Modal
        function closeRecordDetailModal() {
            document.getElementById('recordDetailModal').classList.remove('show');
        }

        // Export Records
        function exportRecords() {
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for export
            const exportData = appData.attendanceRecords.map(record => ({
                'Date': new Date(record.date).toLocaleDateString(),
                'School': record.school,
                'Class': record.class,
                'Academic Year': record.academicYear,
                'Term': record.term,
                'Total Students': record.students.length,
                'Present': record.presentCount,
                'Absent': record.absentCount,
                'Attendance Rate': `${record.attendanceRate.toFixed(1)}%`,
                'Representative': record.representative,
                'Submitted By': record.submittedBy,
                'Timestamp': new Date(record.timestamp).toLocaleString()
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance Records');
            
            // Export to file
            XLSX.writeFile(wb, `IREME_Attendance_Records_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            logSystemActivity('RECORDS_EXPORTED', 'Exported all attendance records to Excel');
            showAlert('Records exported successfully!', 'success');
        }

        // Sync with Google Sheets
        function syncWithGoogleSheets() {
            const statusDiv = document.getElementById('syncStatus');
            const statusText = document.getElementById('syncStatusText');
            
            statusDiv.style.display = 'block';
            statusText.innerHTML = 'Syncing with Google Sheets...';
            
            // Sync all unsynced records
            const unsyncedRecords = appData.attendanceRecords.filter(record => !record.synced);
            
            if (unsyncedRecords.length === 0) {
                statusText.innerHTML = 'All records are already synced!';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
                return;
            }
            
            let syncedCount = 0;
            
            unsyncedRecords.forEach(record => {
                sendToGoogleSheets(record);
                record.synced = true;
                syncedCount++;
            });
            
            saveToStorage();
            
            statusText.innerHTML = `Successfully synced ${syncedCount} records to Google Sheets!`;
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
            
            logSystemActivity('SHEETS_SYNC', `Synced ${syncedCount} records to Google Sheets`);
            showAlert(`Successfully synced ${syncedCount} records to Google Sheets!`, 'success');
        }

        // Load Users List
        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            appData.users.forEach(user => {
                if (user.username === 'admin' && currentUser.username !== 'admin') return; // Hide admin from non-admin users
                
                const userCard = document.createElement('div');
                userCard.className = 'user-management-card';
                userCard.innerHTML = `
                    <div class="user-details">
                        <strong>${user.fullName}</strong>
                        <div style="color: #666; font-size: 0.9em;">
                            Username: ${user.username} | Role: ${user.role} | Created: ${new Date(user.created).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary btn-small" onclick="editUser('${user.username}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        ${user.username !== 'admin' ? `
                            <button class="btn btn-danger btn-small" onclick="deleteUser('${user.username}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        ` : ''}
                    </div>
                `;
                usersList.appendChild(userCard);
            });
        }

        // Add User
        function addUser() {
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const fullName = document.getElementById('newUserFullName').value.trim();
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !password || !fullName || !role) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }
            
            // Check if username already exists
            if (appData.users.find(u => u.username === username)) {
                showAlert('Username already exists', 'error');
                return;
            }
            
            // Add user
            appData.users.push({
                username: username,
                password: password,
                role: role,
                fullName: fullName,
                created: new Date().toISOString(),
                createdBy: currentUser.username
            });
            
            saveToStorage();
            
            // Clear form
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserFullName').value = '';
            document.getElementById('newUserRole').value = '';
            document.getElementById('passwordStrength').className = 'password-strength';
            
            // Reload users list
            loadUsersList();
            
            logSystemActivity('USER_ADDED', `Added user: ${username} (${role})`);
            showAlert(`User ${fullName} added successfully!`, 'success');
        }

        // Edit User
        function editUser(username) {
            const user = appData.users.find(u => u.username === username);
            if (!user) return;
            
            document.getElementById('editUserOriginalUsername').value = user.username;
            document.getElementById('editUserUsername').value = user.username;
            document.getElementById('editUserFullName').value = user.fullName;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserPassword').value = '';
            
            document.getElementById('editUserModal').classList.add('show');
        }

        // Save User Edit
        function saveUserEdit(event) {
            event.preventDefault();
            
            const originalUsername = document.getElementById('editUserOriginalUsername').value;
            const username = document.getElementById('editUserUsername').value.trim();
            const password = document.getElementById('editUserPassword').value;
            const fullName = document.getElementById('editUserFullName').value.trim();
            const role = document.getElementById('editUserRole').value;
            
            if (!username || !fullName || !role) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            // Find user
            const userIndex = appData.users.findIndex(u => u.username === originalUsername);
            if (userIndex === -1) {
                showAlert('User not found', 'error');
                return;
            }
            
            // Check if username is already taken by another user
            if (username !== originalUsername && appData.users.find(u => u.username === username && u.username !== originalUsername)) {
                showAlert('Username already exists', 'error');
                return;
            }
            
            // Update user
            appData.users[userIndex].username = username;
            appData.users[userIndex].fullName = fullName;
            appData.users[userIndex].role = role;
            
            if (password) {
                appData.users[userIndex].password = password;
            }
            
            saveToStorage();
            
            // Close modal
            document.getElementById('editUserModal').classList.remove('show');
            
            // Reload users list
            loadUsersList();
            
            logSystemActivity('USER_EDITED', `Edited user: ${username} (${role})`);
            showAlert(`User ${fullName} updated successfully!`, 'success');
        }

        // Delete User
        function deleteUser(username) {
            if (username === 'admin') {
                showAlert('Cannot delete admin user', 'error');
                return;
            }
            
            if (username === currentUser.username) {
                showAlert('Cannot delete your own account', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to delete user ${username}?`)) {
                appData.users = appData.users.filter(u => u.username !== username);
                saveToStorage();
                loadUsersList();
                
                logSystemActivity('USER_DELETED', `Deleted user: ${username}`);
                showAlert(`User ${username} deleted successfully!`, 'success');
            }
        }

        // Load Admin Students
        function loadAdminStudents() {
            const adminStudentList = document.getElementById('adminStudentList');
            adminStudentList.innerHTML = '';
            
            if (appData.students.length === 0) {
                adminStudentList.innerHTML = '<div class="alert alert-info">No students found. Add students using the form above.</div>';
                return;
            }
            
            appData.students.forEach(student => {
                const school = appData.schools.find(s => s.id == student.schoolId);
                const studentCard = document.createElement('div');
                studentCard.className = 'student-item';
                studentCard.innerHTML = `
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-id">${student.id}</div>
                        <div class="student-gender ${student.gender === 'Male' ? 'gender-male' : 'gender-female'}">
                            ${student.gender}
                        </div>
                        <div>${school ? school.name : 'Unknown School'}</div>
                        <div>${student.class}</div>
                        <div class="user-actions">
                            <button class="btn btn-primary btn-small" onclick="generateSingleQRCode('${student.id}')">
                                <i class="fas fa-qrcode"></i> QR
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteStudent('${student.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                adminStudentList.appendChild(studentCard);
            });
        }

        // Search Admin Students
        function searchAdminStudents() {
            const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
            const studentItems = document.querySelectorAll('#adminStudentList .student-item');
            
            studentItems.forEach(item => {
                const name = item.querySelector('.student-name').textContent.toLowerCase();
                const id = item.querySelector('.student-id').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || id.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Add Student
        function addStudent(event) {
            event.preventDefault();
            
            const id = document.getElementById('newStudentId').value.trim().toUpperCase();
            const name = document.getElementById('newStudentName').value.trim();
            const gender = document.getElementById('newStudentGender').value;
            const schoolId = document.getElementById('newStudentSchool').value;
            const className = document.getElementById('newStudentClass').value;
            
            if (!id || !name || !gender || !schoolId || !className) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            // Check if student ID already exists
            if (appData.students.find(s => s.id === id)) {
                showAlert('Student ID already exists', 'error');
                return;
            }
            
            // Add student
            appData.students.push({
                id: id,
                name: name,
                gender: gender,
                schoolId: parseInt(schoolId),
                class: className
            });
            
            saveToStorage();
            
            // Clear form
            document.getElementById('addStudentForm').reset();
            
            // Reload students list
            loadAdminStudents();
            
            logSystemActivity('STUDENT_ADDED', `Added student: ${name} (${id})`);
            showAlert(`Student ${name} added successfully!`, 'success');
        }

        // Update New Student Classes
        function updateNewStudentClasses() {
            const schoolId = document.getElementById('newStudentSchool').value;
            const classSelect = document.getElementById('newStudentClass');
            
            classSelect.innerHTML = '<option value="">Select Class</option>';
            
            if (schoolId) {
                const school = appData.schools.find(s => s.id == schoolId);
                if (school && school.classes) {
                    school.classes.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });
                }
            }
        }

        // Delete Student
        function deleteStudent(studentId) {
            if (confirm(`Are you sure you want to delete student ${studentId}?`)) {
                appData.students = appData.students.filter(s => s.id !== studentId);
                saveToStorage();
                loadAdminStudents();
                
                logSystemActivity('STUDENT_DELETED', `Deleted student: ${studentId}`);
                showAlert(`Student ${studentId} deleted successfully!`, 'success');
            }
        }

        // Generate QR Code
        function generateQRCode() {
            const qrModal = document.getElementById('qrModal');
            const qrDisplay = document.getElementById('qrCodeDisplay');
            
            qrDisplay.innerHTML = '<div class="alert alert-info"><i class="fas fa-sync fa-spin"></i> Generating QR codes...</div>';
            qrModal.classList.add('show');
            
            setTimeout(() => {
                qrDisplay.innerHTML = '';
                
                const qrGrid = document.createElement('div');
                qrGrid.className = 'qr-grid';
                
                appData.students.forEach(student => {
                    const school = appData.schools.find(s => s.id == student.schoolId);
                    
                    const qrCard = document.createElement('div');
                    qrCard.className = 'qr-card';
                    qrCard.innerHTML = `
                        <div class="qr-code-display" id="qr-${student.id}"></div>
                        <div class="qr-card-info">
                            <div class="qr-card-name">${student.name}</div>
                            <div class="qr-card-id">${student.id}</div>
                            <div class="qr-card-detail">${student.gender}  ${student.class}</div>
                            <div class="qr-card-school">${school ? school.name : 'Unknown School'}</div>
                        </div>
                    `;
                    
                    qrGrid.appendChild(qrCard);
                    
                    // Generate QR code
                    QRCode.toCanvas(document.getElementById(`qr-${student.id}`), student.id, {
                        width: 150,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function(error) {
                        if (error) console.error(error);
                    });
                });
                
                qrDisplay.appendChild(qrGrid);
            }, 100);
        }

        // Generate Single QR Code
        function generateSingleQRCode(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) return;
            
            const school = appData.schools.find(s => s.id == student.schoolId);
            const qrModal = document.getElementById('qrModal');
            const qrDisplay = document.getElementById('qrCodeDisplay');
            
            qrDisplay.innerHTML = `
                <div class="qr-grid">
                    <div class="qr-card">
                        <div class="qr-code-display" id="qr-single-${student.id}"></div>
                        <div class="qr-card-info">
                            <div class="qr-card-name">${student.name}</div>
                            <div class="qr-card-id">${student.id}</div>
                            <div class="qr-card-detail">${student.gender}  ${student.class}</div>
                            <div class="qr-card-school">${school ? school.name : 'Unknown School'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            qrModal.classList.add('show');
            
            // Generate QR code
            setTimeout(() => {
                QRCode.toCanvas(document.getElementById(`qr-single-${student.id}`), student.id, {
                    width: 200,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function(error) {
                    if (error) console.error(error);
                });
            }, 100);
        }

        // Close QR Modal
        function closeQRModal() {
            document.getElementById('qrModal').classList.remove('show');
        }

        // Print QR Cards
        function printQRCards() {
            window.print();
        }

        // Download QR Cards as PDF
        function downloadQRCardsAsPDF() {
            const modalContent = document.querySelector('#qrModal .modal-content');
            
            html2canvas(modalContent).then(canvas => {
                const link = document.createElement('a');
                link.download = `IREME_QR_Codes_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // Download All QR Codes
        function downloadAllQRCodes() {
            const zip = new JSZip();
            const qrFolder = zip.folder("qr_codes");
            
            let processed = 0;
            const total = appData.students.length;
            
            appData.students.forEach(student => {
                const canvas = document.createElement('canvas');
                QRCode.toCanvas(canvas, student.id, {
                    width: 300,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function(error) {
                    if (error) {
                        console.error(error);
                        processed++;
                        if (processed === total) {
                            finalizeZip(zip);
                        }
                        return;
                    }
                    
                    canvas.toBlob(function(blob) {
                        qrFolder.file(`${student.id}_${student.name}.png`, blob);
                        processed++;
                        
                        if (processed === total) {
                            finalizeZip(zip);
                        }
                    });
                });
            });
            
            function finalizeZip(zip) {
                zip.generateAsync({type: "blob"}).then(function(content) {
                    const link = document.createElement('a');
                    link.download = `IREME_QR_Codes_${new Date().toISOString().split('T')[0]}.zip`;
                    link.href = URL.createObjectURL(content);
                    link.click();
                });
            }
            
            showAlert('Preparing QR codes for download...', 'info');
        }

        // Add School
        function addSchool() {
            const schoolName = document.getElementById('newSchoolName').value.trim();
            
            if (!schoolName) {
                showAlert('Please enter a school name', 'error');
                return;
            }
            
            // Check if school already exists
            if (appData.schools.find(s => s.name.toLowerCase() === schoolName.toLowerCase())) {
                showAlert('School already exists', 'error');
                return;
            }
            
            // Add school
            const newSchool = {
                id: Date.now(),
                name: schoolName,
                classes: []
            };
            
            appData.schools.push(newSchool);
            saveToStorage();
            
            // Clear input
            document.getElementById('newSchoolName').value = '';
            
            // Update school selects
            populateSchoolSelects();
            
            logSystemActivity('SCHOOL_ADDED', `Added school: ${schoolName}`);
            showAlert(`School ${schoolName} added successfully!`, 'success');
        }

        // Add Class
        function addClass() {
            const schoolId = document.getElementById('schoolForClass').value;
            const className = document.getElementById('newClassName').value.trim();
            
            if (!schoolId || !className) {
                showAlert('Please select a school and enter a class name', 'error');
                return;
            }
            
            // Find school
            const school = appData.schools.find(s => s.id == schoolId);
            if (!school) {
                showAlert('School not found', 'error');
                return;
            }
            
            // Check if class already exists
            if (school.classes.includes(className)) {
                showAlert('Class already exists in this school', 'error');
                return;
            }
            
            // Add class
            school.classes.push(className);
            saveToStorage();
            
            // Clear input
            document.getElementById('newClassName').value = '';
            
            // Update UI
            loadClasses();
            updateNewStudentClasses();
            
            logSystemActivity('CLASS_ADDED', `Added class: ${className} to ${school.name}`);
            showAlert(`Class ${className} added to ${school.name} successfully!`, 'success');
        }

        // Handle Bulk Upload
        function handleBulkUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const progressBar = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Reading file...';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first worksheet
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        showAlert('No data found in the file', 'error');
                        progressBar.style.display = 'none';
                        return;
                    }
                    
                    let processed = 0;
                    let added = 0;
                    let skipped = 0;
                    
                    jsonData.forEach((row, index) => {
                        setTimeout(() => {
                            // Validate required fields
                            if (!row['Student ID'] || !row['Name'] || !row['Gender'] || !row['School'] || !row['Class']) {
                                skipped++;
                                processed++;
                                updateProgress();
                                return;
                            }
                            
                            // Check if student already exists
                            if (appData.students.find(s => s.id === row['Student ID'])) {
                                skipped++;
                                processed++;
                                updateProgress();
                                return;
                            }
                            
                            // Find school by name
                            let school = appData.schools.find(s => s.name === row['School']);
                            
                            // Create school if it doesn't exist
                            if (!school) {
                                school = {
                                    id: Date.now() + index,
                                    name: row['School'],
                                    classes: []
                                };
                                appData.schools.push(school);
                            }
                            
                            // Add class to school if it doesn't exist
                            if (!school.classes.includes(row['Class'])) {
                                school.classes.push(row['Class']);
                            }
                            
                            // Add student
                            appData.students.push({
                                id: row['Student ID'],
                                name: row['Name'],
                                gender: row['Gender'],
                                schoolId: school.id,
                                class: row['Class']
                            });
                            
                            added++;
                            processed++;
                            updateProgress();
                            
                            function updateProgress() {
                                const progress = (processed / jsonData.length) * 100;
                                progressFill.style.width = `${progress}%`;
                                progressText.textContent = `Processed ${processed}/${jsonData.length} (${added} added, ${skipped} skipped)`;
                                
                                if (processed === jsonData.length) {
                                    setTimeout(() => {
                                        saveToStorage();
                                        populateSchoolSelects();
                                        loadAdminStudents();
                                        
                                        progressBar.style.display = 'none';
                                        document.getElementById('bulkStudentFile').value = '';
                                        
                                        logSystemActivity('BULK_UPLOAD', `Bulk uploaded ${added} students, skipped ${skipped}`);
                                        showAlert(`Bulk upload completed! ${added} students added, ${skipped} skipped.`, 'success');
                                    }, 500);
                                }
                            }
                        }, index * 10); // Small delay to prevent UI freezing
                    });
                } catch (error) {
                    console.error('Error processing file:', error);
                    showAlert('Error processing file. Please check the format.', 'error');
                    progressBar.style.display = 'none';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Enhanced Google Sheets Settings - Now only saves secondary URL
        function saveSheetsSettings() {
            if (currentUser.role !== 'admin') {
                showAlert('Only administrators can modify sheet settings.', 'error');
                return;
            }
            
            const secondaryUrl = document.getElementById('secondarySheetsUrl').value.trim();
            const syncFreq = document.getElementById('syncFrequency').value;
            
            // Primary URL is fixed, only save secondary
            appData.settings.secondarySheetsUrl = secondaryUrl;
            appData.settings.syncFrequency = syncFreq;
            
            saveToStorage();
            logSystemActivity('SETTINGS_UPDATE', 'Google Sheets configuration updated (secondary URL)');
            showAlert('Sheet settings saved successfully!', 'success');
        }

        async function testAllConnections() {
            const statusDiv = document.getElementById('syncStatus');
            const statusText = document.getElementById('syncStatusText');
            
            statusDiv.style.display = 'block';
            statusText.innerHTML = 'Testing primary connection (fixed)...';
            
            // Test primary connection (fixed URL)
            if (await testConnection(PRIMARY_GOOGLE_SCRIPT_URL)) {
                statusText.innerHTML += '<br> Primary connection successful';
                
                // Test secondary if exists
                if (appData.settings.secondarySheetsUrl) {
                    statusText.innerHTML += '<br>Testing secondary connection...';
                    if (await testConnection(appData.settings.secondarySheetsUrl)) {
                        statusText.innerHTML += '<br> Secondary connection successful';
                    } else {
                        statusText.innerHTML += '<br> Secondary connection failed';
                    }
                }
            } else {
                statusText.innerHTML += '<br> Primary connection failed';
            }
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        async function testConnection(url) {
            if (!url) return false;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'test' })
                });
                return true;
            } catch (error) {
                return false;
            }
        }

        // Google Sheets Integration - Now uses fixed primary URL
        function sendToGoogleSheets(record) {
            // Always send to primary URL (fixed)
            const sheetData = {
                action: 'submitAttendance',
                timestamp: new Date().toISOString(),
                record: record
            };

            // Send to primary URL (fixed)
            if (PRIMARY_GOOGLE_SCRIPT_URL.includes('script.google.com')) {
                fetch(PRIMARY_GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sheetData)
                })
                .then(() => {
                    const recordIndex = appData.attendanceRecords.findIndex(r => r.id === record.id);
                    if (recordIndex !== -1) {
                        appData.attendanceRecords[recordIndex].synced = true;
                        saveToStorage();
                    }
                    console.log('Data sent to Primary Google Sheets');
                })
                .catch((error) => {
                    console.error('Error sending to Primary Google Sheets:', error);
                });
            }

            // Also send to secondary URL if configured
            if (appData.settings.secondarySheetsUrl) {
                fetch(appData.settings.secondarySheetsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sheetData)
                })
                .then(() => {
                    console.log('Data also sent to Secondary Google Sheets');
                })
                .catch((error) => {
                    console.error('Error sending to Secondary Google Sheets:', error);
                });
            }
        }

        async function manualSync() {
            const statusDiv = document.getElementById('syncStatus');
            const statusText = document.getElementById('syncStatusText');
            
            statusDiv.style.display = 'block';
            statusText.innerHTML = 'Starting manual sync...';
            
            if (await syncAllDataToCloud()) {
                statusText.innerHTML = ' Sync completed successfully!';
                showAlert('All data synced to cloud!', 'success');
            } else {
                statusText.innerHTML = ' Sync failed. Check connection.';
                showAlert('Sync failed. Please check your connection.', 'error');
            }
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        function getSyncInterval() {
            switch (appData.settings.syncFrequency) {
                case 'realtime': return 1000; // 1 second
                case '5min': return 5 * 60 * 1000; // 5 minutes
                case '15min': return 15 * 60 * 1000; // 15 minutes
                case 'manual': return 24 * 60 * 60 * 1000; // 24 hours (effectively manual)
                default: return 5 * 60 * 1000; // Default 5 minutes
            }
        }

        function autoSyncData() {
            if (navigator.onLine) {
                syncAllDataToCloud().then(success => {
                    if (success) {
                        console.log('Auto-sync completed');
                    }
                });
            }
        }

        // Export All Data
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.download = `IREME_Attendance_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.href = URL.createObjectURL(dataBlob);
            link.click();
            
            logSystemActivity('DATA_EXPORTED', 'Exported all data as backup');
            showAlert('All data exported successfully!', 'success');
        }

        // Import Data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (confirm('This will replace all current data. Are you sure?')) {
                            appData = importedData;
                            saveToStorage();
                            
                            // Reload UI
                            if (currentUser) {
                                populateSchoolSelects();
                                populateFilterSelects();
                                loadRecords();
                                loadUsersList();
                                loadAdminStudents();
                            }
                            
                            logSystemActivity('DATA_IMPORTED', 'Imported data from backup');
                            showAlert('Data imported successfully!', 'success');
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        showAlert('Error importing data. Please check the file format.', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Clear All Data
        function clearAllData() {
            if (confirm('This will delete ALL data including users, students, and attendance records. This action cannot be undone. Are you sure?')) {
                if (confirm('This is your final warning. ALL data will be permanently deleted. Continue?')) {
                    localStorage.removeItem('iremeAttendanceData');
                    location.reload();
                }
            }
        }

        // Populate Filter Selects
        function populateFilterSelects() {
            const filterSchool = document.getElementById('filterSchool');
            const filterClass = document.getElementById('filterClass');
            
            filterSchool.innerHTML = '<option value="">All Schools</option>';
            filterClass.innerHTML = '<option value="">All Classes</option>';
            
            appData.schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.name;
                filterSchool.appendChild(option);
            });
        }

        // Check Online Status
        function checkOnlineStatus() {
            if (!navigator.onLine) {
                document.getElementById('offlineIndicator').classList.add('show');
            }
        }

        // Show Alert
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => {
                if (alert.parentElement) {
                    alert.parentElement.removeChild(alert);
                }
            });
            
            // Create new alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${getAlertIcon(type)}"></i>
                <div>${message}</div>
            `;
            
            // Add to page
            const content = document.querySelector('.content');
            if (content) {
                content.insertBefore(alert, content.firstChild);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.parentElement.removeChild(alert);
                }
            }, 5000);
        }

        function getAlertIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                case 'info': return 'info-circle';
                default: return 'info-circle';
            }
        }

        // Initialize on load
        window.addEventListener('load', initApp);
    </script>
</body>
</html>