<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IREME Attendance Tracker Pro</title>
    <meta name="description" content="Professional Student Attendance Tracking System for IREME & Move Up Global">
    <meta name="theme-color" content="#4CAF50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --danger: #F44336;
            --warning: #FF9800;
            --success: #4CAF50;
            --dark: #212121;
            --light: #f5f5f5;
            --border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            animation: fadeInUp 0.5s;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header i {
            font-size: 4em;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .login-header h1 {
            color: var(--dark);
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            width: 100%;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #45a049);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #1976D2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #d32f2f);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f57c00);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #45a049);
            color: white;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            width: auto;
        }

        .app-container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none;
        }

        .app-container.show {
            display: block;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary), #45a049);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 1.6em;
            margin-bottom: 5px;
        }

        .header-title p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
        }

        .user-info span {
            font-size: 0.9em;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:active {
            transform: scale(0.95);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            min-width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: white;
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .nav-tab.hidden {
            display: none;
        }

        .content {
            padding: 20px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: var(--light);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), #45a049);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card.secondary {
            background: linear-gradient(135deg, var(--secondary), #1976D2);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger), #d32f2f);
        }

        .stat-number {
            font-size: 2.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.95em;
            opacity: 0.95;
        }

        .student-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s;
        }

        .student-item:active {
            background: var(--light);
        }

        .student-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .student-info {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .student-name {
            font-weight: 600;
            color: var(--dark);
        }

        .student-id {
            color: var(--secondary);
            font-family: monospace;
            font-weight: 600;
        }

        .student-gender {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .gender-male {
            background: #e3f2fd;
            color: #1976d2;
        }

        .gender-female {
            background: #fce4ec;
            color: #c2185b;
        }

        /* Mobile-optimized QR Scanner */
        .scanner-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #qr-reader {
            border-radius: 10px;
            overflow: hidden;
            max-width: 100%;
            margin: 0 auto;
        }

        #qr-reader video {
            width: 100% !important;
            height: auto !important;
            border-radius: 10px;
            max-height: 60vh;
            object-fit: cover;
        }

        #qr-reader__scan_region {
            border-radius: 10px !important;
        }

        .manual-entry {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .manual-entry input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1.2em;
            text-align: center;
            font-family: monospace;
            text-transform: uppercase;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 15px 45px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 1.2em;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success);
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger);
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning);
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid var(--secondary);
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .records-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .records-table tr:active {
            background: var(--light);
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 3px dashed var(--border);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--light);
        }

        .file-upload:active {
            border-color: var(--primary);
            background: rgba(76, 175, 80, 0.05);
        }

        .file-upload i {
            font-size: 3em;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: zoomIn 0.3s;
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 1.5em;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }

        .close-btn:active {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #45a049);
            width: 0%;
            transition: width 0.3s;
        }

        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .offline-indicator.show {
            display: block;
        }

        .date-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .qr-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            page-break-inside: avoid;
        }

        .qr-code-display {
            margin: 10px auto;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 10px;
            background: white;
            display: inline-block;
        }

        .qr-code-display canvas {
            display: block;
            margin: 0 auto;
        }

        .qr-card-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .qr-card-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .qr-card-id {
            font-family: monospace;
            color: var(--secondary);
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1em;
        }

        .qr-card-detail {
            color: #666;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .qr-card-school {
            color: var(--primary);
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.95em;
        }

        .user-management-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details {
            flex: 1;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .app-container {
                margin: 10px;
                border-radius: 15px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .student-info {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: auto;
            }

            .quick-actions {
                flex-direction: column;
            }

            .quick-actions .btn {
                width: 100%;
            }

            .qr-grid {
                grid-template-columns: 1fr;
            }

            .user-management-card {
                flex-direction: column;
                gap: 10px;
            }

            .user-actions {
                width: 100%;
                justify-content: center;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .modal, .modal * {
                visibility: visible;
            }
            .modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white;
            }
            .modal-content {
                box-shadow: none;
                border: none;
            }
            .close-btn, .quick-actions {
                display: none !important;
            }
            .qr-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            .qr-card {
                break-inside: avoid;
                border: 2px solid #000;
            }
        }

        /* Password strength indicator */
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .password-strength.weak {
            background: var(--danger);
            width: 33%;
        }

        .password-strength.medium {
            background: var(--warning);
            width: 66%;
        }

        .password-strength.strong {
            background: var(--success);
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <i class="fas fa-clipboard-check"></i>
                <h1>IREME Attendance Tracker</h1>
                <p>Move Up Global & IREME Education for Social Impact</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="loginUsername" required placeholder="Enter your username">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-user-tag"></i> Login As</label>
                    <select id="loginRole" required>
                        <option value="">Select Role</option>
                        <option value="representative">Class Representative</option>
                        <option value="internal">Internal Team</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>

            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px; font-size: 0.9em;">
                <strong>Default Admin:</strong><br>
                Username: xxxx<br>
                Password: oxxox-@vu
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="header-content">
                <div class="header-title">
                    <h1><i class="fas fa-clipboard-check"></i> IREME Attendance Pro</h1>
                    <p>Move Up Global & IREME Education for Social Impact</p>
                </div>
                <div class="user-info">
                    <span><i class="fas fa-user"></i> <strong id="currentUser">User</strong></span>
                    <span><i class="fas fa-user-tag"></i> <strong id="currentRole">Role</strong></span>
                    <span><i class="fas fa-calendar"></i> <strong id="currentDate"></strong></span>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="take-attendance" id="tabTakeAttendance">
                <i class="fas fa-check-circle"></i> Take Attendance
            </button>
            <button class="nav-tab" data-tab="view-records" id="tabViewRecords">
                <i class="fas fa-history"></i> View Records
            </button>
            <button class="nav-tab hidden" data-tab="admin" id="tabAdmin">
                <i class="fas fa-user-shield"></i> Admin Panel
            </button>
            <button class="nav-tab" data-tab="settings" id="tabSettings">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Take Attendance Tab -->
            <div id="take-attendance" class="tab-content active">
                <div class="date-display">
                    <i class="fas fa-calendar-day"></i> Today: <span id="attendanceDate"></span>
                </div>

                <!-- Selection Form -->
                <div class="form-section">
                    <h3><i class="fas fa-school"></i> Select Class</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>School *</label>
                            <select id="selectSchool" required>
                                <option value="">Select School</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Class *</label>
                            <select id="selectClass" required>
                                <option value="">Select Class</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Academic Year *</label>
                            <select id="selectAcademicYear" required>
                                <option value="">Select Year</option>
                                <option value="2025-2026" selected>2024-2025</option>
                                <option value="2026-2027">2025-2026</option>
                                <option value="2027-2028">2026-2027</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Term *</label>
                            <select id="selectTerm" required>
                                <option value="">Select Term</option>
                                <option value="Term1">Term 1</option>
                                <option value="Term2">Term 2</option>
                                <option value="Term3">Term 3</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="startAttendanceBtn">
                        <i class="fas fa-play"></i> Start Taking Attendance
                    </button>
                </div>

                <!-- Attendance Interface -->
                <div id="attendanceInterface" style="display: none;">
                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card secondary">
                            <div class="stat-number" id="presentCount">0</div>
                            <div class="stat-label">Present</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-number" id="absentCount">0</div>
                            <div class="stat-label">Absent</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button class="btn btn-primary btn-small" id="markAllPresentBtn">
                            <i class="fas fa-check-double"></i> Mark All Present
                        </button>
                        <button class="btn btn-danger btn-small" id="markAllAbsentBtn">
                            <i class="fas fa-times"></i> Mark All Absent
                        </button>
                        <button class="btn btn-secondary btn-small" id="toggleScannerBtn">
                            <i class="fas fa-qrcode"></i> QR Scanner
                        </button>
                        <button class="btn btn-warning btn-small" id="toggleManualEntryBtn">
                            <i class="fas fa-keyboard"></i> Manual Entry
                        </button>
                    </div>

                    <!-- QR Scanner -->
                    <div id="scannerSection" class="scanner-container" style="display: none;">
                        <h3><i class="fas fa-qrcode"></i> Scan Student QR Code</h3>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <div>Point your camera at the student's QR code. The system will automatically mark them present.</div>
                        </div>
                        <div id="qr-reader"></div>
                        <button class="btn btn-danger btn-small" id="stopScannerBtn" style="margin-top: 15px; width: 100%;">
                            <i class="fas fa-stop"></i> Stop Scanner
                        </button>
                    </div>

                    <!-- Manual Entry -->
                    <div id="manualEntrySection" class="manual-entry" style="display: none;">
                        <h3><i class="fas fa-keyboard"></i> Enter Student ID Manually</h3>
                        <input type="text" id="manualStudentId" placeholder="Enter Student ID (e.g., XXXXXX01)">
                        <button class="btn btn-primary" id="markManualBtn" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-check"></i> Mark Present
                        </button>
                    </div>

                    <!-- Search -->
                    <div class="search-box">
                        <input type="text" id="studentSearch" placeholder="Search student by name or ID...">
                        <i class="fas fa-search"></i>
                    </div>

                    <!-- Student List -->
                    <div class="student-list" id="studentList"></div>

                    <!-- Submit Button -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" id="submitAttendanceBtn" style="padding: 15px 40px; font-size: 1.1em;">
                            <i class="fas fa-paper-plane"></i> Submit Attendance
                        </button>
                    </div>
                </div>
            </div>

            <!-- View Records Tab -->
            <div id="view-records" class="tab-content">
                <div class="form-section">
                    <h3><i class="fas fa-filter"></i> Filter Records</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>School</label>
                            <select id="filterSchool">
                                <option value="">All Schools</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Class</label>
                            <select id="filterClass">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date From</label>
                            <input type="date" id="filterDateFrom">
                        </div>
                        <div class="form-group">
                            <label>Date To</label>
                            <input type="date" id="filterDateTo">
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" id="exportRecordsBtn">
                            <i class="fas fa-download"></i> Export Records
                        </button>
                        <button class="btn btn-secondary" id="syncSheetsBtn">
                            <i class="fas fa-sync"></i> Sync with Google Sheets
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>School</th>
                                <th>Class</th>
                                <th>Total</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Rate</th>
                                <th>Representative</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="admin" class="tab-content">
                <!-- User Management -->
                <div class="form-section">
                    <h3><i class="fas fa-users-cog"></i> User Management</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Admin Privileges:</strong> Create, edit, and delete user accounts. Assign roles and manage permissions.
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" id="newUserUsername" placeholder="Enter username" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="password" id="newUserPassword" placeholder="Enter password (min 6 characters)" autocomplete="new-password">
                            <div class="password-strength" id="passwordStrength"></div>
                        </div>
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="newUserFullName" placeholder="Full name" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Role *</label>
                            <select id="newUserRole">
                                <option value="">Select Role</option>
                                <option value="representative">Class Representative</option>
                                <option value="internal">Internal Team</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" id="addUserBtn">
                        <i class="fas fa-user-plus"></i> Add User
                    </button>
                </div>

                <!-- Current Users -->
                <div class="form-section">
                    <h3><i class="fas fa-users"></i> Current Users</h3>
                    <div id="usersList"></div>
                </div>

                <!-- Bulk Student Upload -->
                <div class="form-section">
                    <h3><i class="fas fa-upload"></i> Bulk Student Upload</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Excel Format Required:</strong> Student ID, Name, Gender, School, Class<br>
                            <small>The system will automatically generate QR codes for all students</small>
                        </div>
                    </div>
                    <div class="file-upload" id="bulkUploadArea">
                        <i class="fas fa-file-excel"></i>
                        <h4>Click to Upload Excel File</h4>
                        <p>Supported: .xlsx, .xls, .csv</p>
                        <input type="file" id="bulkStudentFile" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText" style="text-align: center; margin-top: 10px;"></p>
                    </div>
                </div>

                <!-- Add Single Student -->
                <div class="form-section">
                    <h3><i class="fas fa-user-plus"></i> Add Individual Student</h3>
                    <form id="addStudentForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Student ID *</label>
                                <input type="text" id="newStudentId" required placeholder="e.g., ABC123">
                            </div>
                            <div class="form-group">
                                <label>Student Name *</label>
                                <input type="text" id="newStudentName" required placeholder="Full Name">
                            </div>
                            <div class="form-group">
                                <label>Gender *</label>
                                <select id="newStudentGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>School *</label>
                                <select id="newStudentSchool" required>
                                    <option value="">Select School</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Class *</label>
                                <select id="newStudentClass" required>
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                        </div>
                        <div class="quick-actions">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                            <button type="button" class="btn btn-secondary" id="generateSingleQRBtn">
                                <i class="fas fa-qrcode"></i> Generate QR Code
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Manage Students -->
                <div class="form-section">
                    <h3><i class="fas fa-search"></i> Search & Manage Students</h3>
                    <div class="search-box">
                        <input type="text" id="adminSearch" placeholder="Search by name or ID...">
                        <i class="fas fa-search"></i>
                    </div>
                    <div id="adminStudentList"></div>
                </div>

                <!-- Manage Schools -->
                <div class="form-section">
                    <h3><i class="fas fa-school"></i> Manage Schools & Classes</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Add New School</label>
                            <input type="text" id="newSchoolName" placeholder="School Name">
                            <button class="btn btn-primary btn-small" id="addSchoolBtn" style="margin-top: 10px; width: 100%;">
                                <i class="fas fa-plus"></i> Add School
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Add Class to School</label>
                            <select id="schoolForClass">
                                <option value="">Select School</option>
                            </select>
                            <input type="text" id="newClassName" placeholder="e.g., P1 A" style="margin-top: 10px;">
                            <button class="btn btn-primary btn-small" id="addClassBtn" style="margin-top: 10px; width: 100%;">
                                <i class="fas fa-plus"></i> Add Class
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="form-section">
                    <h3><i class="fas fa-link"></i> Google Sheets Integration</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Setup Instructions:</strong><br>
                            1. Create a Google Apps Script with the provided code<br>
                            2. Deploy as Web App and copy the URL<br>
                            3. Paste the URL below to enable automatic syncing
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Google Apps Script URL</label>
                        <input type="url" id="googleSheetsUrl" placeholder="https://script.google.com/...">
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary" id="saveSettingsBtn">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        <button class="btn btn-secondary" id="testConnectionBtn">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-database"></i> Data Management</h3>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Warning:</strong> These actions will affect all stored data. Use with caution.
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-secondary" id="exportAllDataBtn">
                            <i class="fas fa-download"></i> Export All Data (Backup)
                        </button>
                        <button class="btn btn-warning" id="importDataBtn">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                        <button class="btn btn-danger" id="clearAllDataBtn">
                            <i class="fas fa-trash-alt"></i> Clear All Data
                        </button>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-mobile-alt"></i> Mobile App Installation</h3>
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Install on Mobile:</strong><br>
                            <strong>iOS:</strong> Tap Share → Add to Home Screen<br>
                            <strong>Android:</strong> Tap Menu (⋮) → Add to Home Screen<br>
                            The app will work offline and use your device camera for QR scanning.
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> App Information</h3>
                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h4>IREME Attendance Tracker Professional v3.0</h4>
                        <p><strong>Developed for:</strong> IREME & Move Up Global</p>
                        <p><strong>Features:</strong></p>
                        <ul style="text-align: left; margin: 15px 0;">
                            <li>✅ Full admin user management with password controls</li>
                            <li>✅ Mobile-optimized QR scanning (iOS & Android)</li>
                            <li>✅ Offline-capable attendance tracking</li>
                            <li>✅ Cloud data storage integration</li>
                            <li>✅ Bulk student upload via Excel</li>
                            <li>✅ Automatic QR code generation</li>
                            <li>✅ Google Sheets integration</li>
                            <li>✅ Real-time statistics & editing</li>
                            <li>✅ Multi-school & multi-class support</li>
                            <li>✅ Role-based access control</li>
                            <li>✅ Progressive Web App (installable)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-qrcode"></i> Student QR Codes</h2>
                <button class="close-btn" id="closeQRModal">&times;</button>
            </div>
            <div id="qrCodeDisplay"></div>
            <div class="quick-actions" style="margin-top: 20px;">
                <button class="btn btn-primary" id="printQRCardsBtn">
                    <i class="fas fa-print"></i> Print QR Cards
                </button>
                <button class="btn btn-secondary" id="downloadQRCardsBtn">
                    <i class="fas fa-download"></i> Download as Image
                </button>
                <button class="btn btn-success" id="downloadAllQRCodesBtn">
                    <i class="fas fa-file-archive"></i> Download ZIP
                </button>
            </div>
        </div>
    </div>

    <!-- Record Detail Modal -->
    <div id="recordDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-clipboard-list"></i> Attendance Details</h2>
                <button class="close-btn" id="closeRecordDetailModal">&times;</button>
            </div>
            <div id="recordDetailContent"></div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h2>
                <button class="close-btn" id="closeEditUserModal">&times;</button>
            </div>
            <div id="editUserContent">
                <form id="editUserForm">
                    <input type="hidden" id="editUserOriginalUsername">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="editUserUsername" required>
                        </div>
                        <div class="form-group">
                            <label>New Password (leave blank to keep current)</label>
                            <input type="password" id="editUserPassword" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="editUserFullName" required>
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select id="editUserRole" required>
                                <option value="representative">Class Representative</option>
                                <option value="internal">Internal Team</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('editUserModal').classList.remove('show')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i> Offline Mode - Data will sync when online
    </div>

    <script>
        // Global Variables
        let appData = {
            users: [
                { username: 'admin', password: 'Avasgnyawe@123', role: 'admin', fullName: 'System Administrator' }
                { username: 'admin', password: 'Mugireme.321', role: 'admin', fullName: 'System Administrator' }
            ],
            schools: [],
            students: [],
            attendanceRecords: [],
            settings: {
                googleSheetsUrl: ''
            }
        };

        let currentUser = null;
        let currentAttendance = {
            school: '',
            schoolId: null,
            class: '',
            academicYear: '',
            term: '',
            date: '',
            representative: '',
            students: []
        };

        let html5QrCode = null;
        let isScanning = false;

        // Initialize App
        function initApp() {
            loadFromStorage();
            updateCurrentDate();
            checkOnlineStatus();
            setupEventListeners();
            
            setInterval(updateCurrentDate, 60000);
            setInterval(saveToStorage, 30000);
            
            window.addEventListener('online', () => {
                document.getElementById('offlineIndicator').classList.remove('show');
                showAlert('Back online! You can now sync data.', 'success');
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('offlineIndicator').classList.add('show');
            });

            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    console.log('Service worker registration optional');
                });
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation Tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Attendance
            document.getElementById('selectSchool').addEventListener('change', loadClasses);
            document.getElementById('startAttendanceBtn').addEventListener('click', startAttendance);
            document.getElementById('markAllPresentBtn').addEventListener('click', markAllPresent);
            document.getElementById('markAllAbsentBtn').addEventListener('click', markAllAbsent);
            document.getElementById('toggleScannerBtn').addEventListener('click', toggleScanner);
            document.getElementById('toggleManualEntryBtn').addEventListener('click', toggleManualEntry);
            document.getElementById('stopScannerBtn').addEventListener('click', stopScanner);
            document.getElementById('markManualBtn').addEventListener('click', markByManualId);
            document.getElementById('manualStudentId').addEventListener('keypress', handleManualEntry);
            document.getElementById('studentSearch').addEventListener('input', searchStudents);
            document.getElementById('submitAttendanceBtn').addEventListener('click', submitAttendance);

            // Admin - Password strength indicator
            document.getElementById('newUserPassword').addEventListener('input', function() {
                checkPasswordStrength(this.value);
            });

            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('addStudentForm').addEventListener('submit', addStudent);
            document.getElementById('generateSingleQRBtn').addEventListener('click', generateQRCode);
            document.getElementById('adminSearch').addEventListener('input', searchAdminStudents);
            document.getElementById('addSchoolBtn').addEventListener('click', addSchool);
            document.getElementById('addClassBtn').addEventListener('click', addClass);
            document.getElementById('newStudentSchool').addEventListener('change', updateNewStudentClasses);

            // File Upload
            document.getElementById('bulkUploadArea').addEventListener('click', () => {
                document.getElementById('bulkStudentFile').click();
            });
            document.getElementById('bulkStudentFile').addEventListener('change', handleBulkUpload);

            // Settings
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
            document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
            document.getElementById('importDataBtn').addEventListener('click', importData);
            document.getElementById('clearAllDataBtn').addEventListener('click', clearAllData);

            // Records
            document.getElementById('exportRecordsBtn').addEventListener('click', exportRecords);
            document.getElementById('syncSheetsBtn').addEventListener('click', syncWithGoogleSheets);

            // Modals
            document.getElementById('closeQRModal').addEventListener('click', closeQRModal);
            document.getElementById('closeRecordDetailModal').addEventListener('click', closeRecordDetailModal);
            document.getElementById('closeEditUserModal').addEventListener('click', () => {
                document.getElementById('editUserModal').classList.remove('show');
            });
            document.getElementById('printQRCardsBtn').addEventListener('click', printQRCards);
            document.getElementById('downloadQRCardsBtn').addEventListener('click', downloadQRCardsAsPDF);
            document.getElementById('downloadAllQRCodesBtn').addEventListener('click', downloadAllQRCodes);
            document.getElementById('editUserForm').addEventListener('submit', saveUserEdit);

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            });
        }

        // Password Strength Checker
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('passwordStrength');
            if (!password) {
                strengthBar.className = 'password-strength';
                return;
            }

            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            if (strength <= 2) {
                strengthBar.className = 'password-strength weak';
            } else if (strength <= 3) {
                strengthBar.className = 'password-strength medium';
            } else {
                strengthBar.className = 'password-strength strong';
            }
        }

        // Storage Functions
        function loadFromStorage() {
            const stored = localStorage.getItem('iremeAttendanceData');
            if (stored) {
                const loaded = JSON.parse(stored);
                appData = { ...appData, ...loaded };
            } else {
                initializeSampleData();
            }
        }

        function saveToStorage() {
            localStorage.setItem('iremeAttendanceData', JSON.stringify(appData));
        }

        function initializeSampleData() {
            appData.schools = [
                {
                    id: 1,
                    name: 'RWINZOVU PRIMARY SCHOOL',
                    classes: ['N1', 'N2', 'N3', 'P1 A', 'P1 B', 'P2 A', 'P2 B', 'P3', 'P4', 'P5', 'P6']
                },
                {
                    id: 2,
                    name: 'MUSANZE SECONDARY SCHOOL',
                    classes: ['S1 A', 'S1 B', 'S2 A', 'S2 B', 'S3', 'S4', 'S5', 'S6']
                }
            ];

            appData.students = [
                { id: 'RWN001', name: 'UWIMANA Jean', gender: 'Male', schoolId: 1, class: 'P6' },
                { id: 'RWN002', name: 'MUKAMANA Alice', gender: 'Female', schoolId: 1, class: 'P6' },
                { id: 'RWN003', name: 'HABIMANA Eric', gender: 'Male', schoolId: 1, class: 'P6' },
                { id: 'MUS001', name: 'NIYONSENGA Grace', gender: 'Female', schoolId: 2, class: 'S3' },
                { id: 'MUS002', name: 'UWASE David', gender: 'Male', schoolId: 2, class: 'S3' }
            ];

            saveToStorage();
        }

        // Authentication
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const role = document.getElementById('loginRole').value;
            
            const user = appData.users.find(u => 
                u.username === username && 
                u.password === password && 
                u.role === role
            );
            
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').classList.add('show');
                document.getElementById('currentUser').textContent = user.fullName;
                document.getElementById('currentRole').textContent = user.role.toUpperCase();
                
                setupUIForRole(user.role);
                populateSchoolSelects();
                populateFilterSelects();
                
                showAlert(`Welcome ${user.fullName}!`, 'success');
            } else {
                showAlert('Invalid credentials or role. Please try again.', 'error');
            }
        }

        function setupUIForRole(role) {
            const tabAdmin = document.getElementById('tabAdmin');
            const tabTakeAttendance = document.getElementById('tabTakeAttendance');
            
            if (role === 'admin') {
                tabAdmin.classList.remove('hidden');
            } else {
                tabAdmin.classList.add('hidden');
            }
            
            if (role === 'internal') {
                tabTakeAttendance.classList.add('hidden');
            } else {
                tabTakeAttendance.classList.remove('hidden');
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                stopScanner();
                document.getElementById('mainApp').classList.remove('show');
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('loginForm').reset();
                switchTab('take-attendance');
            }
        }

        // Update Date
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = now.toLocaleDateString('en-US', options);
            document.getElementById('currentDate').textContent = dateStr;
            if (document.getElementById('attendanceDate')) {
                document.getElementById('attendanceDate').textContent = dateStr;
            }
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'view-records') {
                loadRecords();
            } else if (tabName === 'admin') {
                loadUsersList();
                loadAdminStudents();
                populateSchoolSelects();
            }
        }

        // Populate School Selects
        function populateSchoolSelects() {
            const selects = ['selectSchool', 'newStudentSchool', 'schoolForClass', 'filterSchool'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select School</option>';
                    appData.schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        select.appendChild(option);
                    });
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        // Load Classes
        function loadClasses() {
            const schoolId = parseInt(document.getElementById('selectSchool').value);
            const classSelect = document.getElementById('selectClass');
            classSelect.innerHTML = '<option value="">Select Class</option>';
            
            if (schoolId) {
                const school = appData.schools.find(s => s.id === schoolId);
                if (school) {
                    school.classes.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });
                }
            }
        }

        function updateNewStudentClasses() {
            const schoolId = parseInt(document.getElementById('newStudentSchool').value);
            const classSelect = document.getElementById('newStudentClass');
            classSelect.innerHTML = '<option value="">Select Class</option>';
            
            if (schoolId) {
                const school = appData.schools.find(s => s.id === schoolId);
                if (school) {
                    school.classes.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });
                }
            }
        }

        // Load Students
        function loadStudents() {
            const schoolId = parseInt(document.getElementById('selectSchool').value);
            const className = document.getElementById('selectClass').value;
            
            if (schoolId && className) {
                currentAttendance.students = appData.students.filter(
                    s => s.schoolId === schoolId && s.class === className
                ).map(s => ({
                    ...s,
                    present: false
                }));
            }
        }

        // Start Attendance
        function startAttendance() {
            const schoolId = document.getElementById('selectSchool').value;
            const className = document.getElementById('selectClass').value;
            const academicYear = document.getElementById('selectAcademicYear').value;
            const term = document.getElementById('selectTerm').value;

            if (!schoolId || !className || !academicYear || !term) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            const school = appData.schools.find(s => s.id === parseInt(schoolId));
            currentAttendance.school = school.name;
            currentAttendance.schoolId = parseInt(schoolId);
            currentAttendance.class = className;
            currentAttendance.academicYear = academicYear;
            currentAttendance.term = term;
            currentAttendance.date = new Date().toISOString().split('T')[0];
            currentAttendance.representative = currentUser.fullName;

            loadStudents();
            document.getElementById('attendanceInterface').style.display = 'block';
            
            displayStudentList();
            updateAttendanceStats();
            
            showAlert('Attendance started successfully!', 'success');
            
            document.getElementById('attendanceInterface').scrollIntoView({ behavior: 'smooth' });
        }

        // Display Student List
        function displayStudentList(filterText = '') {
            const listContainer = document.getElementById('studentList');
            listContainer.innerHTML = '';

            let students = currentAttendance.students;
            if (filterText) {
                students = students.filter(s => 
                    s.name.toLowerCase().includes(filterText.toLowerCase()) ||
                    s.id.toLowerCase().includes(filterText.toLowerCase())
                );
            }

            if (students.length === 0) {
                listContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No students found</div>';
                return;
            }

            students.forEach(student => {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.innerHTML = `
                    <input type="checkbox" class="student-checkbox" 
                           ${student.present ? 'checked' : ''} 
                           onchange="toggleAttendance('${student.id}')">
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-id">${student.id}</div>
                        <div>
                            <span class="student-gender ${student.gender === 'Male' ? 'gender-male' : 'gender-female'}">
                                ${student.gender}
                            </span>
                        </div>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }

        // Toggle Attendance
        function toggleAttendance(studentId) {
            const student = currentAttendance.students.find(s => s.id === studentId);
            if (student) {
                student.present = !student.present;
                updateAttendanceStats();
            }
        }

        // Update Stats
        function updateAttendanceStats() {
            const total = currentAttendance.students.length;
            const present = currentAttendance.students.filter(s => s.present).length;
            const absent = total - present;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
        }

        // Quick Actions
        function markAllPresent() {
            currentAttendance.students.forEach(s => s.present = true);
            displayStudentList();
            updateAttendanceStats();
            showAlert('All students marked as present', 'success');
        }

        function markAllAbsent() {
            currentAttendance.students.forEach(s => s.present = false);
            displayStudentList();
            updateAttendanceStats();
            showAlert('All students marked as absent', 'warning');
        }

        // QR Scanner - MOBILE OPTIMIZED
        function toggleScanner() {
            const scannerSection = document.getElementById('scannerSection');
            if (scannerSection.style.display === 'none') {
                scannerSection.style.display = 'block';
                startScanner();
            } else {
                scannerSection.style.display = 'none';
                stopScanner();
            }
        }

        function startScanner() {
            if (isScanning) return;
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            // Request camera permission and start scanning
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    // Prefer back camera on mobile devices
                    let cameraId = devices[0].id;
                    if (devices.length > 1) {
                        const backCamera = devices.find(device => 
                            device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('rear')
                        );
                        if (backCamera) {
                            cameraId = backCamera.id;
                        } else {
                            cameraId = devices[devices.length - 1].id;
                        }
                    }
                    
                    const config = {
                        fps: 10,
                        qrbox: function(viewfinderWidth, viewfinderHeight) {
                            // Make QR box responsive
                            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                            let qrboxSize = Math.floor(minEdge * 0.7);
                            return {
                                width: qrboxSize,
                                height: qrboxSize
                            };
                        },
                        aspectRatio: 1.0
                    };
                    
                    html5QrCode.start(
                        cameraId,
                        config,
                        (decodedText) => {
                            markStudentPresent(decodedText);
                            // Vibrate on successful scan (mobile)
                            if (navigator.vibrate) {
                                navigator.vibrate(200);
                            }
                        },
                        (errorMessage) => {
                            // Silently ignore scanning errors
                        }
                    ).then(() => {
                        isScanning = true;
                        showAlert('Scanner started. Point camera at QR code.', 'info');
                    }).catch(err => {
                        showAlert('Unable to start camera: ' + err, 'error');
                        console.error(err);
                    });
                }
            }).catch(err => {
                showAlert('No camera found on this device', 'error');
                console.error(err);
            });
        }

        function stopScanner() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    html5QrCode.clear();
                    showAlert('Scanner stopped', 'info');
                }).catch(err => console.error(err));
            }
        }

        function markStudentPresent(studentId) {
            const student = currentAttendance.students.find(s => s.id.toUpperCase() === studentId.toUpperCase());
            if (student) {
                if (!student.present) {
                    student.present = true;
                    displayStudentList();
                    updateAttendanceStats();
                    showAlert(`✓ ${student.name} marked as present!`, 'success');
                } else {
                    showAlert(`${student.name} already marked present`, 'info');
                }
            } else {
                showAlert('Student ID not found in this class', 'error');
            }
        }

        // Manual Entry
        function toggleManualEntry() {
            const section = document.getElementById('manualEntrySection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            if (section.style.display === 'block') {
                document.getElementById('manualStudentId').focus();
            }
        }

        function handleManualEntry(event) {
            if (event.key === 'Enter') {
                markByManualId();
            }
        }

        function markByManualId() {
            const studentId = document.getElementById('manualStudentId').value.trim().toUpperCase();
            if (studentId) {
                markStudentPresent(studentId);
                document.getElementById('manualStudentId').value = '';
            }
        }

        // Search Students
        function searchStudents() {
            const searchText = document.getElementById('studentSearch').value;
            displayStudentList(searchText);
        }

        // Submit Attendance
        function submitAttendance() {
            if (currentAttendance.students.length === 0) {
                showAlert('No students to submit', 'error');
                return;
            }

            const presentCount = currentAttendance.students.filter(s => s.present).length;
            const absentCount = currentAttendance.students.length - presentCount;
            
            const confirmMsg = `Submit attendance for ${currentAttendance.school} - ${currentAttendance.class}?\n\nPresent: ${presentCount}\nAbsent: ${absentCount}`;
            
            if (!confirm(confirmMsg)) return;

            const record = {
                id: Date.now(),
                date: currentAttendance.date,
                school: currentAttendance.school,
                schoolId: currentAttendance.schoolId,
                class: currentAttendance.class,
                academicYear: currentAttendance.academicYear,
                term: currentAttendance.term,
                representative: currentAttendance.representative,
                totalStudents: currentAttendance.students.length,
                presentCount: presentCount,
                absentCount: absentCount,
                attendanceRate: Math.round((presentCount / currentAttendance.students.length) * 100),
                students: currentAttendance.students.map(s => ({
                    id: s.id,
                    name: s.name,
                    gender: s.gender,
                    present: s.present
                })),
                timestamp: new Date().toISOString(),
                synced: false
            };

            appData.attendanceRecords.push(record);
            saveToStorage();
            sendToGoogleSheets(record);

            showAlert('✓ Attendance submitted successfully!', 'success');
            
            // Reset
            document.getElementById('attendanceInterface').style.display = 'none';
            document.getElementById('selectSchool').value = '';
            document.getElementById('selectClass').value = '';
            currentAttendance = {
                school: '', schoolId: null, class: '', academicYear: '', term: '', date: '', representative: '', students: []
            };
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Google Sheets Integration
        function sendToGoogleSheets(record) {
            const sheetsUrl = appData.settings.googleSheetsUrl;
            
            if (!sheetsUrl) {
                console.log('Google Sheets URL not configured');
                return;
            }

            const sheetData = {
                action: 'submitAttendance',
                timestamp: new Date().toISOString(),
                record: record
            };

            if (sheetsUrl.includes('script.google.com')) {
                fetch(sheetsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sheetData)
                })
                .then(() => {
                    const recordIndex = appData.attendanceRecords.findIndex(r => r.id === record.id);
                    if (recordIndex !== -1) {
                        appData.attendanceRecords[recordIndex].synced = true;
                        saveToStorage();
                    }
                    console.log('Data sent to Google Sheets');
                })
                .catch((error) => {
                    console.error('Error sending to Google Sheets:', error);
                });
            }
        }

        // Load Records
        function loadRecords() {
            const tbody = document.getElementById('recordsTableBody');
            tbody.innerHTML = '';

            if (appData.attendanceRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">No attendance records yet</td></tr>';
                return;
            }

            const sortedRecords = [...appData.attendanceRecords].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                const canEdit = currentUser && (currentUser.role === 'admin' || currentUser.role === 'representative');
                
                row.innerHTML = `
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>${record.school}</td>
                    <td>${record.class}</td>
                    <td>${record.totalStudents}</td>
                    <td style="color: var(--success); font-weight: bold;">${record.presentCount}</td>
                    <td style="color: var(--danger); font-weight: bold;">${record.absentCount}</td>
                    <td>
                        <span style="background: ${record.attendanceRate >= 80 ? 'var(--success)' : record.attendanceRate >= 60 ? 'var(--warning)' : 'var(--danger)'}; color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold;">
                            ${record.attendanceRate}%
                        </span>
                    </td>
                    <td>${record.representative}</td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="viewRecordDetails(${record.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${canEdit ? `
                        <button class="btn btn-warning btn-small" onclick="editRecord(${record.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        ` : ''}
                        ${currentUser && currentUser.role === 'admin' ? `
                        <button class="btn btn-danger btn-small" onclick="deleteRecord(${record.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewRecordDetails(recordId) {
            const record = appData.attendanceRecords.find(r => r.id === recordId);
            if (!record) return;

            const modal = document.getElementById('recordDetailModal');
            const content = document.getElementById('recordDetailContent');
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <h3>Attendance Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${record.totalStudents}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card secondary">
                            <div class="stat-number">${record.presentCount}</div>
                            <div class="stat-label">Present</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-number">${record.absentCount}</div>
                            <div class="stat-label">Absent</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: var(--light); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p><strong>Date:</strong> ${new Date(record.date).toLocaleDateString()}</p>
                    <p><strong>School:</strong> ${record.school}</p>
                    <p><strong>Class:</strong> ${record.class}</p>
                    <p><strong>Academic Year:</strong> ${record.academicYear}</p>
                    <p><strong>Term:</strong> ${record.term}</p>
                    <p><strong>Representative:</strong> ${record.representative}</p>
                </div>

                <h4>Student List:</h4>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Gender</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            record.students.forEach(student => {
                html += `
                    <tr>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${student.gender}</td>
                        <td>
                            <span style="color: ${student.present ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">
                                ${student.present ? '✓ Present' : '✗ Absent'}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            content.innerHTML = html;
            modal.classList.add('show');
        }

        function closeRecordDetailModal() {
            document.getElementById('recordDetailModal').classList.remove('show');
        }

        function editRecord(recordId) {
            const record = appData.attendanceRecords.find(r => r.id === recordId);
            if (!record) return;

            currentAttendance = {
                school: record.school,
                schoolId: record.schoolId,
                class: record.class,
                academicYear: record.academicYear,
                term: record.term,
                date: record.date,
                representative: record.representative,
                students: record.students.map(s => ({
                    id: s.id,
                    name: s.name,
                    gender: s.gender,
                    present: s.present
                }))
            };

            switchTab('take-attendance');
            document.getElementById('attendanceInterface').style.display = 'block';
            displayStudentList();
            updateAttendanceStats();
            
            appData.attendanceRecords = appData.attendanceRecords.filter(r => r.id !== recordId);
            saveToStorage();
            
            showAlert('Record loaded for editing. Submit when done.', 'info');
        }

        function deleteRecord(recordId) {
            if (!confirm('Are you sure you want to delete this attendance record?')) return;

            appData.attendanceRecords = appData.attendanceRecords.filter(r => r.id !== recordId);
            saveToStorage();
            loadRecords();
            showAlert('Record deleted successfully', 'success');
        }

        function populateFilterSelects() {
            const filterSchool = document.getElementById('filterSchool');
            if (filterSchool) {
                filterSchool.innerHTML = '<option value="">All Schools</option>';
                appData.schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    filterSchool.appendChild(option);
                });
            }
        }

        // Export Records
        function exportRecords() {
            if (appData.attendanceRecords.length === 0) {
                showAlert('No records to export', 'warning');
                return;
            }

            const csv = convertToCSV(appData.attendanceRecords);
            downloadCSV(csv, `attendance_records_${new Date().toISOString().split('T')[0]}.csv`);
            showAlert('Records exported successfully!', 'success');
        }

        function convertToCSV(records) {
            const headers = ['Date', 'School', 'Class', 'Academic Year', 'Term', 'Total', 'Present', 'Absent', 'Rate', 'Representative'];
            const rows = records.map(r => [
                r.date,
                r.school,
                r.class,
                r.academicYear,
                r.term,
                r.totalStudents,
                r.presentCount,
                r.absentCount,
                r.attendanceRate + '%',
                r.representative
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function syncWithGoogleSheets() {
            if (!navigator.onLine) {
                showAlert('You are offline. Please connect to the internet to sync.', 'error');
                return;
            }

            const unsyncedRecords = appData.attendanceRecords.filter(r => !r.synced);
            if (unsyncedRecords.length === 0) {
                showAlert('All data is already synced', 'info');
                return;
            }

            unsyncedRecords.forEach(record => {
                sendToGoogleSheets(record);
            });

            showAlert(`Syncing ${unsyncedRecords.length} records...`, 'info');
        }

        // User Management - ADMIN ONLY
        function addUser() {
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const fullName = document.getElementById('newUserFullName').value.trim();
            const role = document.getElementById('newUserRole').value;

            if (!username || !password || !fullName || !role) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('Password must be at least 6 characters long', 'error');
                return;
            }

            if (appData.users.some(u => u.username === username)) {
                showAlert('Username already exists', 'error');
                return;
            }

            appData.users.push({ username, password, fullName, role });
            saveToStorage();
            loadUsersList();
            
            document.getElementById('newUserUsername').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserFullName').value = '';
            document.getElementById('newUserRole').value = '';
            document.getElementById('passwordStrength').className = 'password-strength';
            
            showAlert(`User ${fullName} added successfully!`, 'success');
        }

        function loadUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';

            appData.users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-management-card';
                div.innerHTML = `
                    <div class="user-details">
                        <div><strong>${user.fullName}</strong></div>
                        <div style="color: #666; font-size: 0.9em;">@${user.username} • ${user.role.toUpperCase()}</div>
                    </div>
                    <div class="user-actions">
                        ${user.username !== 'admin' ? `
                        <button class="btn btn-warning btn-small" onclick="openEditUser('${user.username}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-small" onclick="removeUser('${user.username}')">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                        ` : '<span style="color: #666; font-size: 0.9em;">Default Admin</span>'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openEditUser(username) {
            const user = appData.users.find(u => u.username === username);
            if (!user) return;

            document.getElementById('editUserOriginalUsername').value = username;
            document.getElementById('editUserUsername').value = user.username;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserFullName').value = user.fullName;
            document.getElementById('editUserRole').value = user.role;

            document.getElementById('editUserModal').classList.add('show');
        }

        function saveUserEdit(event) {
            event.preventDefault();

            const originalUsername = document.getElementById('editUserOriginalUsername').value;
            const newUsername = document.getElementById('editUserUsername').value.trim();
            const newPassword = document.getElementById('editUserPassword').value;
            const fullName = document.getElementById('editUserFullName').value.trim();
            const role = document.getElementById('editUserRole').value;

            if (!newUsername || !fullName || !role) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            const userIndex = appData.users.findIndex(u => u.username === originalUsername);
            if (userIndex === -1) return;

            // Check if new username conflicts with another user
            if (newUsername !== originalUsername && appData.users.some(u => u.username === newUsername)) {
                showAlert('Username already exists', 'error');
                return;
            }

            appData.users[userIndex].username = newUsername;
            appData.users[userIndex].fullName = fullName;
            appData.users[userIndex].role = role;
            
            // Only update password if provided
            if (newPassword) {
                if (newPassword.length < 6) {
                    showAlert('Password must be at least 6 characters long', 'error');
                    return;
                }
                appData.users[userIndex].password = newPassword;
            }

            saveToStorage();
            loadUsersList();
            document.getElementById('editUserModal').classList.remove('show');
            showAlert('User updated successfully!', 'success');
        }

        function removeUser(username) {
            if (username === 'admin') {
                showAlert('Cannot remove default admin user', 'error');
                return;
            }

            if (!confirm(`Remove user ${username}?`)) return;

            appData.users = appData.users.filter(u => u.username !== username);
            saveToStorage();
            loadUsersList();
            showAlert('User removed successfully', 'success');
        }

        // Bulk Student Upload
        function handleBulkUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    processBulkStudents(jsonData);
                } catch (error) {
                    showAlert('Error reading file: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processBulkStudents(data) {
            document.getElementById('uploadProgress').style.display = 'block';
            
            let added = 0;
            let skipped = 0;
            const newStudents = [];
            
            data.forEach((row, index) => {
                const progress = ((index + 1) / data.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = `Processing ${index + 1} of ${data.length}...`;
                
                const studentId = (row['Student ID'] || row['ID'] || '').toString().trim().toUpperCase();
                const name = (row['Name'] || row['Student Name'] || '').toString().trim();
                const gender = (row['Gender'] || '').toString().trim();
                const schoolName = (row['School'] || '').toString().trim();
                const className = (row['Class'] || '').toString().trim();
                
                if (!studentId || !name || !gender || !schoolName || !className) {
                    skipped++;
                    return;
                }
                
                if (appData.students.some(s => s.id === studentId)) {
                    skipped++;
                    return;
                }
                
                let school = appData.schools.find(s => s.name.toLowerCase() === schoolName.toLowerCase());
                if (!school) {
                    school = {
                        id: appData.schools.length + 1,
                        name: schoolName,
                        classes: [className]
                    };
                    appData.schools.push(school);
                } else if (!school.classes.includes(className)) {
                    school.classes.push(className);
                }
                
                const student = {
                    id: studentId,
                    name: name,
                    gender: gender,
                    schoolId: school.id,
                    class: className
                };
                
                appData.students.push(student);
                newStudents.push(student);
                added++;
            });
            
            saveToStorage();
            
            setTimeout(() => {
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('progressFill').style.width = '0%';
                
                showAlert(`Upload complete! Added: ${added}, Skipped: ${skipped}`, 'success');
                
                if (added > 0) {
                    generateBulkQRCodes(newStudents);
                }
                
                populateSchoolSelects();
                loadAdminStudents();
                
                document.getElementById('bulkStudentFile').value = '';
            }, 500);
        }

        // QR CODE GENERATION - FIXED VERSION
        function generateBulkQRCodes(students) {
            const modal = document.getElementById('qrModal');
            const display = document.getElementById('qrCodeDisplay');
            display.innerHTML = '';

            const grid = document.createElement('div');
            grid.className = 'qr-grid';
            display.appendChild(grid);

            students.forEach((student, index) => {
                const school = appData.schools.find(s => s.id === student.schoolId);
                const schoolName = school ? school.name : 'Unknown School';

                const card = document.createElement('div');
                card.className = 'qr-card';
                
                const qrContainer = document.createElement('div');
                qrContainer.className = 'qr-code-display';
                qrContainer.id = `qr-${student.id}`;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'qr-card-info';
                infoDiv.innerHTML = `
                    <div class="qr-card-name">${student.name}</div>
                    <div class="qr-card-id">ID: ${student.id}</div>
                    <div class="qr-card-detail">Gender: ${student.gender}</div>
                    <div class="qr-card-detail">Class: ${student.class}</div>
                    <div class="qr-card-school">${schoolName}</div>
                    <div style="margin-top: 8px; font-size: 0.8em; color: #888;">
                        IREME & Move Up Global
                    </div>
                `;

                card.appendChild(qrContainer);
                card.appendChild(infoDiv);
                grid.appendChild(card);

                setTimeout(() => {
                    try {
                        new QRCode(qrContainer, {
                            text: student.id,
                            width: 180,
                            height: 180,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    } catch (error) {
                        console.error('QR code generation error:', error);
                    }
                }, index * 100);
            });

            modal.classList.add('show');
        }

        function generateQRCode() {
            const studentId = document.getElementById('newStudentId').value.trim().toUpperCase();
            const studentName = document.getElementById('newStudentName').value.trim();
            const studentGender = document.getElementById('newStudentGender').value;
            const studentSchoolId = parseInt(document.getElementById('newStudentSchool').value);
            const studentClass = document.getElementById('newStudentClass').value;
            
            if (!studentId || !studentName || !studentGender || !studentSchoolId || !studentClass) {
                showAlert('Please enter all student information first', 'error');
                return;
            }

            const school = appData.schools.find(s => s.id === studentSchoolId);
            const schoolName = school ? school.name : 'Unknown School';

            const modal = document.getElementById('qrModal');
            const display = document.getElementById('qrCodeDisplay');
            display.innerHTML = '';

            const grid = document.createElement('div');
            grid.className = 'qr-grid';
            display.appendChild(grid);

            const card = document.createElement('div');
            card.className = 'qr-card';
            
            const qrContainer = document.createElement('div');
            qrContainer.className = 'qr-code-display';
            qrContainer.id = `single-qr-${studentId}`;
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'qr-card-info';
            infoDiv.innerHTML = `
                <div class="qr-card-name">${studentName}</div>
                <div class="qr-card-id">ID: ${studentId}</div>
                <div class="qr-card-detail">Gender: ${studentGender}</div>
                <div class="qr-card-detail">Class: ${studentClass}</div>
                <div class="qr-card-school">${schoolName}</div>
                <div style="margin-top: 8px; font-size: 0.8em; color: #888;">
                    IREME & Move Up Global
                </div>
            `;

            card.appendChild(qrContainer);
            card.appendChild(infoDiv);
            grid.appendChild(card);

            setTimeout(() => {
                try {
                    new QRCode(qrContainer, {
                        text: studentId,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } catch (error) {
                    console.error('QR code generation error:', error);
                    showAlert('Error generating QR code', 'error');
                }
            }, 100);

            modal.classList.add('show');

            if (!appData.students.some(s => s.id === studentId)) {
                const student = {
                    id: studentId,
                    name: studentName,
                    gender: studentGender,
                    schoolId: studentSchoolId,
                    class: studentClass
                };
                appData.students.push(student);
                saveToStorage();
                showAlert(`Student ${studentName} added to database and QR code generated!`, 'success');
            } else {
                showAlert('QR code generated for existing student!', 'success');
            }
        }

        function closeQRModal() {
            document.getElementById('qrModal').classList.remove('show');
        }

        function printQRCards() {
            window.print();
        }

        function downloadQRCardsAsPDF() {
            const modalContent = document.getElementById('qrCodeDisplay');
            
            showAlert('Generating image, please wait...', 'info');
            
            html2canvas(modalContent, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `student_qr_cards_${new Date().toISOString().split('T')[0]}.png`;
                link.href = imgData;
                link.click();
                showAlert('QR cards downloaded!', 'success');
            }).catch(error => {
                console.error('Error generating image:', error);
                showAlert('Error generating download. Please try printing instead.', 'error');
            });
        }

        function downloadAllQRCodes() {
            const zip = new JSZip();
            const canvases = document.querySelectorAll('.qr-code-display canvas');
            let processed = 0;
            
            if (canvases.length === 0) {
                showAlert('No QR codes to download', 'warning');
                return;
            }
            
            showAlert(`Processing ${canvases.length} QR codes...`, 'info');
            
            canvases.forEach((canvas, index) => {
                const dataUrl = canvas.toDataURL('image/png');
                const base64Data = dataUrl.split(',')[1];
                const studentId = canvas.parentElement.id.replace('qr-', '').replace('single-qr-', '');
                zip.file(`QR_CODE_${studentId}.png`, base64Data, { base64: true });
                
                processed++;
                if (processed === canvases.length) {
                    zip.generateAsync({ type: 'blob' }).then(content => {
                        const url = window.URL.createObjectURL(content);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `student_qr_codes_${new Date().toISOString().split('T')[0]}.zip`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        showAlert('QR codes downloaded successfully!', 'success');
                    });
                }
            });
        }

        // Single Student Management
        function addStudent(event) {
            event.preventDefault();

            const studentId = document.getElementById('newStudentId').value.trim().toUpperCase();
            const name = document.getElementById('newStudentName').value.trim();
            const gender = document.getElementById('newStudentGender').value;
            const schoolId = parseInt(document.getElementById('newStudentSchool').value);
            const className = document.getElementById('newStudentClass').value;

            if (!studentId || !name || !gender || !schoolId || !className) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            if (appData.students.some(s => s.id === studentId)) {
                showAlert('Student ID already exists!', 'error');
                return;
            }

            const student = {
                id: studentId,
                name: name,
                gender: gender,
                schoolId: schoolId,
                class: className
            };

            appData.students.push(student);
            saveToStorage();
            showAlert(`Student ${name} added successfully!`, 'success');
            
            document.getElementById('addStudentForm').reset();
            loadAdminStudents();
        }

        function loadAdminStudents() {
            const container = document.getElementById('adminStudentList');
            container.innerHTML = '';

            if (appData.students.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No students in database</div>';
                return;
            }

            appData.students.forEach(student => {
                const school = appData.schools.find(s => s.id === student.schoolId);
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <div class="student-info">
                        <div><strong>${student.name}</strong></div>
                        <div class="student-id">${student.id}</div>
                        <div>${school ? school.name : 'Unknown'} - ${student.class}</div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeStudent('${student.id}')">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function searchAdminStudents() {
            const searchText = document.getElementById('adminSearch').value.toLowerCase();
            const container = document.getElementById('adminStudentList');
            container.innerHTML = '';

            const filtered = appData.students.filter(s => 
                s.name.toLowerCase().includes(searchText) || 
                s.id.toLowerCase().includes(searchText)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">No students found</div>';
                return;
            }

            filtered.forEach(student => {
                const school = appData.schools.find(s => s.id === student.schoolId);
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <div class="student-info">
                        <div><strong>${student.name}</strong></div>
                        <div class="student-id">${student.id}</div>
                        <div>${school ? school.name : 'Unknown'} - ${student.class}</div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeStudent('${student.id}')">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function removeStudent(studentId) {
            if (!confirm('Are you sure you want to remove this student?')) return;

            appData.students = appData.students.filter(s => s.id !== studentId);
            saveToStorage();
            loadAdminStudents();
            showAlert('Student removed successfully', 'success');
        }

        function addSchool() {
            const schoolName = document.getElementById('newSchoolName').value.trim();
            if (!schoolName) {
                showAlert('Please enter a school name', 'error');
                return;
            }

            const school = {
                id: appData.schools.length + 1,
                name: schoolName,
                classes: []
            };

            appData.schools.push(school);
            saveToStorage();
            populateSchoolSelects();
            document.getElementById('newSchoolName').value = '';
            showAlert(`School "${schoolName}" added successfully!`, 'success');
        }

        function addClass() {
            const schoolId = parseInt(document.getElementById('schoolForClass').value);
            const className = document.getElementById('newClassName').value.trim();

            if (!schoolId || !className) {
                showAlert('Please select a school and enter a class name', 'error');
                return;
            }

            const school = appData.schools.find(s => s.id === schoolId);
            if (school) {
                if (school.classes.includes(className)) {
                    showAlert('This class already exists in the school', 'error');
                    return;
                }
                school.classes.push(className);
                saveToStorage();
                document.getElementById('newClassName').value = '';
                showAlert(`Class "${className}" added to ${school.name}`, 'success');
            }
        }

        // Settings
        function saveSettings() {
            const googleSheetsUrl = document.getElementById('googleSheetsUrl').value.trim();
            appData.settings.googleSheetsUrl = googleSheetsUrl;
            saveToStorage();
            showAlert('Settings saved successfully!', 'success');
        }

        function testConnection() {
            const url = document.getElementById('googleSheetsUrl').value.trim();
            if (!url) {
                showAlert('Please enter a Google Apps Script URL first', 'error');
                return;
            }
            
            if (url.includes('script.google.com')) {
                showAlert('Testing Google Apps Script connection...', 'info');
                fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'test' })
                })
                .then(() => {
                    showAlert('✓ Connection request sent! Check your Google Sheets.', 'success');
                })
                .catch(error => {
                    showAlert('✗ Connection failed. Please check your setup.', 'error');
                });
            } else {
                showAlert('Please use a Google Apps Script URL for automatic integration.', 'info');
            }
        }

        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ireme_attendance_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            showAlert('Backup exported successfully!', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (confirm('This will replace all current data. Continue?')) {
                            appData = imported;
                            saveToStorage();
                            location.reload();
                        }
                    } catch (error) {
                        showAlert('Invalid backup file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (!confirm('⚠️ WARNING: This will delete ALL data including users, students, and attendance records. This action cannot be undone!\n\nType YES in the next prompt to confirm.')) {
                return;
            }

            const confirmation = prompt('Type YES in capital letters to confirm deletion:');
            if (confirmation === 'YES') {
                localStorage.clear();
                showAlert('All data cleared. Page will reload.', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showAlert('Deletion cancelled', 'info');
            }
        }

        // Utility Functions
        function checkOnlineStatus() {
            if (!navigator.onLine) {
                document.getElementById('offlineIndicator').classList.add('show');
            }
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            const icon = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            }[type] || 'info-circle';

            alertDiv.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <div>${message}</div>
            `;

            const activeContent = document.querySelector('.tab-content.active');
            if (activeContent) {
                activeContent.insertBefore(alertDiv, activeContent.firstChild);
                activeContent.scrollTop = 0;

                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }

        // Initialize on load
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
